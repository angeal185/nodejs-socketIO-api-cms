var PromiseConstructor,contexts=require("./contexts"),Parser=require("./parser/parser"),PluginManager=require("./plugin-manager");module.exports=function(r,e,n){var t=function(r,e,o){if(e=e||{},"function"==typeof e&&(o=e,e={}),!o){PromiseConstructor||(PromiseConstructor="undefined"==typeof Promise?require("promise"):Promise);var i=this;return new PromiseConstructor(function(n,o){t.call(i,r,e,function(r,e){r?o(r):n(e)})})}var a,s,u=new PluginManager(this);if(u.addPlugins(e.plugins),e.pluginManager=u,a=new contexts.Parse(e),e.rootFileInfo)s=e.rootFileInfo;else{var l=e.filename||"input",c=l.replace(/[^\/\\]*$/,"");s={filename:l,relativeUrls:a.relativeUrls,rootpath:a.rootpath||"",currentDirectory:c,entryPath:c,rootFilename:l},s.rootpath&&"/"!==s.rootpath.slice(-1)&&(s.rootpath+="/")}var p=new n(a,s);new Parser(a,p,s).parse(r,function(r,n){if(r)return o(r);o(null,n,p,e)},e)};return t};
