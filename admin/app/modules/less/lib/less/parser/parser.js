var LessError=require("../less-error"),tree=require("../tree"),visitors=require("../visitors"),getParserInput=require("./parser-input"),utils=require("../utils"),Parser=function e(r,t,n){function i(e,r){throw new LessError({index:c.i,filename:n.filename,type:r||"Syntax",message:e},t)}function a(e,r,t){var n=e instanceof Function?e.call(u):c.$re(e);if(n)return n;i(r||("string"==typeof e?"expected '"+e+"' got '"+c.currentChar()+"'":"unexpected token"))}function o(e,r){if(c.$char(e))return e;i(r||"expected '"+e+"' got '"+c.currentChar()+"'")}function s(e){var r=n.filename;return{lineNumber:utils.getLocation(e,c.getInput()).line+1,fileName:r}}var u,c=getParserInput();return{parse:function(i,a,o){var s,u,l,f,h=null,d="";if(u=o&&o.globalVars?e.serializeVars(o.globalVars)+"\n":"",l=o&&o.modifyVars?"\n"+e.serializeVars(o.modifyVars):"",r.pluginManager)for(var m=r.pluginManager.getPreProcessors(),p=0;p<m.length;p++)i=m[p].process(i,{context:r,imports:t,fileInfo:n});(u||o&&o.banner)&&(d=(o&&o.banner?o.banner:"")+u,f=t.contentsIgnoredChars,f[n.filename]=f[n.filename]||0,f[n.filename]+=d.length),i=i.replace(/\r\n?/g,"\n"),i=d+i.replace(/^\uFEFF/,"")+l,t.contents[n.filename]=i;try{c.start(i,r.chunkInput,function(e,r){throw new LessError({index:r,type:"Parse",message:e,filename:n.filename},t)}),s=new tree.Ruleset(null,this.parsers.primary()),s.root=!0,s.firstRoot=!0}catch(e){return a(new LessError(e,t,n.filename))}var v=c.end();if(!v.isFinished){var g=v.furthestPossibleErrorMessage;g||(g="Unrecognised input","}"===v.furthestChar?g+=". Possibly missing opening '{'":")"===v.furthestChar?g+=". Possibly missing opening '('":v.furthestReachedEnd&&(g+=". Possibly missing something")),h=new LessError({type:"Parse",message:g,index:v.furthest,filename:n.filename},t)}var w=function(e){return e=h||e||t.error,e?(e instanceof LessError||(e=new LessError(e,t,n.filename)),a(e)):a(null,s)};if(!1===r.processImports)return w();new visitors.ImportVisitor(t,w).run(s)},parsers:u={primary:function(){for(var e,r=this.mixin,t=[];;){for(;;){if(!(e=this.comment()))break;t.push(e)}if(c.finished)break;if(c.peek("}"))break;if(e=this.extendRule())t=t.concat(e);else if(e=r.definition()||this.rule()||this.ruleset()||r.call()||this.rulesetCall()||this.entities.call()||this.directive())t.push(e);else{for(var n=!1;c.$char(";");)n=!0;if(!n)break}}return t},comment:function(){if(c.commentStore.length){var e=c.commentStore.shift();return new tree.Comment(e.text,e.isLineComment,e.index,n)}},entities:{quoted:function(){var e,r=c.i,t=!1;return c.save(),c.$char("~")&&(t=!0),(e=c.$quoted())?(c.forget(),new tree.Quoted(e.charAt(0),e.substr(1,e.length-2),t,r,n)):void c.restore()},keyword:function(){var e=c.$char("%")||c.$re(/^[_A-Za-z-][_A-Za-z0-9-]*/);if(e)return tree.Color.fromKeyword(e)||new tree.Keyword(e)},call:function(){var e,r,t,i=c.i;if(!c.peek(/^url\(/i))return c.save(),(e=c.$re(/^([\w-]+|%|progid:[\w\.]+)\(/))?(e=e[1],"alpha"===e.toLowerCase()&&(t=u.alpha())?(c.forget(),t):(r=this.arguments(),c.$char(")")?(c.forget(),new tree.Call(e,r,i,n)):void c.restore("Could not parse call arguments or missing ')'"))):void c.forget()},arguments:function(){var e,r,t,n=[],i=[],a=[];for(c.save();;){if(!(t=u.detachedRuleset()||this.assignment()||u.expression()))break;r=t,t.value&&1==t.value.length&&(r=t.value[0]),r&&a.push(r),i.push(r),c.$char(",")||(c.$char(";")||e)&&(e=!0,a.length>1&&(r=new tree.Value(a)),n.push(r),a=[])}return c.forget(),e?n:i},literal:function(){return this.dimension()||this.color()||this.quoted()||this.unicodeDescriptor()},assignment:function(){var e,r;return c.save(),(e=c.$re(/^\w+(?=\s?=)/i))&&c.$char("=")&&(r=u.entity())?(c.forget(),new tree.Assignment(e,r)):void c.restore()},url:function(){var e,r=c.i;return c.autoCommentAbsorb=!1,c.$str("url(")?(e=this.quoted()||this.variable()||c.$re(/^(?:(?:\\[\(\)'"])|[^\(\)'"])+/)||"",c.autoCommentAbsorb=!0,o(")"),new tree.URL(null!=e.value||e instanceof tree.Variable?e:new tree.Anonymous(e),r,n)):void(c.autoCommentAbsorb=!0)},variable:function(){var e,r=c.i;if("@"===c.currentChar()&&(e=c.$re(/^@@?[\w-]+/)))return new tree.Variable(e,r,n)},variableCurly:function(){var e,r=c.i;if("@"===c.currentChar()&&(e=c.$re(/^@\{([\w-]+)\}/)))return new tree.Variable("@"+e[1],r,n)},color:function(){var e;if("#"===c.currentChar()&&(e=c.$re(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})/))){var r=e.input.match(/^#([\w]+).*/);return r=r[1],r.match(/^[A-Fa-f0-9]+$/)||i("Invalid HEX color code"),new tree.Color(e[1],void 0,"#"+r)}},colorKeyword:function(){c.save();var e=c.autoCommentAbsorb;c.autoCommentAbsorb=!1;var r=c.$re(/^[_A-Za-z-][_A-Za-z0-9-]+/);if(c.autoCommentAbsorb=e,!r)return void c.forget();c.restore();var t=tree.Color.fromKeyword(r);return t?(c.$str(r),t):void 0},dimension:function(){if(!c.peekNotNumeric()){var e=c.$re(/^([+-]?\d*\.?\d+)(%|[a-z_]+)?/i);return e?new tree.Dimension(e[1],e[2]):void 0}},unicodeDescriptor:function(){var e;if(e=c.$re(/^U\+[0-9a-fA-F?]+(\-[0-9a-fA-F?]+)?/))return new tree.UnicodeDescriptor(e[0])},javascript:function(){var e,r=c.i;c.save();var t=c.$char("~");return c.$char("`")?(e=c.$re(/^[^`]*`/))?(c.forget(),new tree.JavaScript(e.substr(0,e.length-1),Boolean(t),r,n)):void c.restore("invalid javascript definition"):void c.restore()}},variable:function(){var e;if("@"===c.currentChar()&&(e=c.$re(/^(@[\w-]+)\s*:/)))return e[1]},rulesetCall:function(){var e;if("@"===c.currentChar()&&(e=c.$re(/^(@[\w-]+)\(\s*\)\s*;/)))return new tree.RulesetCall(e[1])},extend:function(e){var r,t,o,s,u,l=c.i;if(c.$str(e?"&:extend(":":extend(")){do{for(o=null,r=null;!(o=c.$re(/^(all)(?=\s*(\)|,))/))&&(t=this.element());)r?r.push(t):r=[t];o=o&&o[1],r||i("Missing target selector for :extend()."),u=new tree.Extend(new tree.Selector(r),o,l,n),s?s.push(u):s=[u]}while(c.$char(","));return a(/^\)/),e&&a(/^;/),s}},extendRule:function(){return this.extend(!0)},mixin:{call:function(){var e,r,t,i,a,s,l=c.currentChar(),f=!1,h=c.i;if("."===l||"#"===l){for(c.save();;){if(e=c.i,!(i=c.$re(/^[#.](?:[\w-]|\\(?:[A-Fa-f0-9]{1,6} ?|[^A-Fa-f0-9]))+/)))break;t=new tree.Element(a,i,e,n),r?r.push(t):r=[t],a=c.$char(">")}if(r&&(c.$char("(")&&(s=this.args(!0).args,o(")")),u.important()&&(f=!0),u.end()))return c.forget(),new tree.mixin.Call(r,s,h,n,f);c.restore()}},args:function(e){var r,t,n,a,o,s,l,f=u.entities,h={args:null,variadic:!1},d=[],m=[],p=[];for(c.save();;){if(e)s=u.detachedRuleset()||u.expression();else{if(c.commentStore.length=0,c.$str("...")){h.variadic=!0,c.$char(";")&&!r&&(r=!0),(r?m:p).push({variadic:!0});break}s=f.variable()||f.literal()||f.keyword()}if(!s)break;a=null,s.throwAwayComments&&s.throwAwayComments(),o=s;var v=null;if(e?s.value&&1==s.value.length&&(v=s.value[0]):v=s,v&&v instanceof tree.Variable)if(c.$char(":")){if(d.length>0&&(r&&i("Cannot mix ; and , as delimiter types"),t=!0),!(o=u.detachedRuleset()||u.expression())){if(!e)return c.restore(),h.args=[],h;i("could not understand value for named argument")}a=n=v.name}else if(c.$str("...")){if(!e){h.variadic=!0,c.$char(";")&&!r&&(r=!0),(r?m:p).push({name:s.name,variadic:!0});break}l=!0}else e||(n=a=v.name,o=null);o&&d.push(o),p.push({name:a,value:o,expand:l}),c.$char(",")||(c.$char(";")||r)&&(t&&i("Cannot mix ; and , as delimiter types"),r=!0,d.length>1&&(o=new tree.Value(d)),m.push({name:n,value:o,expand:l}),n=null,d=[],t=!1)}return c.forget(),h.args=r?m:p,h},definition:function(){var e,r,t,n,i=[],o=!1;if(!("."!==c.currentChar()&&"#"!==c.currentChar()||c.peek(/^[^{]*\}/)))if(c.save(),r=c.$re(/^([#.](?:[\w-]|\\(?:[A-Fa-f0-9]{1,6} ?|[^A-Fa-f0-9]))+)\s*\(/)){e=r[1];var s=this.args(!1);if(i=s.args,o=s.variadic,!c.$char(")"))return void c.restore("Missing closing ')'");if(c.commentStore.length=0,c.$str("when")&&(n=a(u.conditions,"expected condition")),t=u.block())return c.forget(),new tree.mixin.Definition(e,i,t,n,o);c.restore()}else c.forget()}},entity:function(){var e=this.entities;return this.comment()||e.literal()||e.variable()||e.url()||e.call()||e.keyword()||e.javascript()},end:function(){return c.$char(";")||c.peek("}")},alpha:function(){var e;if(c.$re(/^opacity=/i))return e=c.$re(/^\d+/),e||(e=a(this.entities.variable,"Could not parse alpha")),o(")"),new tree.Alpha(e)},element:function(){var e,r,t,i=c.i;if(r=this.combinator(),e=c.$re(/^(?:\d+\.\d+|\d+)%/)||c.$re(/^(?:[.#]?|:*)(?:[\w-]|[^\x00-\x9f]|\\(?:[A-Fa-f0-9]{1,6} ?|[^A-Fa-f0-9]))+/)||c.$char("*")||c.$char("&")||this.attribute()||c.$re(/^\([^&()@]+\)/)||c.$re(/^[\.#:](?=@)/)||this.entities.variableCurly(),e||(c.save(),c.$char("(")?(t=this.selector())&&c.$char(")")?(e=new tree.Paren(t),c.forget()):c.restore("Missing closing ')'"):c.forget()),e)return new tree.Element(r,e,i,n)},combinator:function(){var e=c.currentChar();if("/"===e){c.save();var r=c.$re(/^\/[a-z]+\//i);if(r)return c.forget(),new tree.Combinator(r);c.restore()}if(">"===e||"+"===e||"~"===e||"|"===e||"^"===e){for(c.i++,"^"===e&&"^"===c.currentChar()&&(e="^^",c.i++);c.isWhitespace();)c.i++;return new tree.Combinator(e)}return c.isWhitespace(-1)?new tree.Combinator(" "):new tree.Combinator(null)},lessSelector:function(){return this.selector(!0)},selector:function(e){for(var r,t,o,s,u,l,f,h=c.i;(e&&(t=this.extend())||e&&(l=c.$str("when"))||(s=this.element()))&&(l?f=a(this.conditions,"expected condition"):f?i("CSS guard can only be used at the end of selector"):t?u=u?u.concat(t):t:(u&&i("Extend can only be used at the end of selector"),o=c.currentChar(),r?r.push(s):r=[s],s=null),"{"!==o&&"}"!==o&&";"!==o&&","!==o&&")"!==o););if(r)return new tree.Selector(r,u,f,h,n);u&&i("Extend must be used to extend a selector, it cannot be used on its own")},attribute:function(){if(c.$char("[")){var e,r,t,n=this.entities;return(e=n.variableCurly())||(e=a(/^(?:[_A-Za-z0-9-\*]*\|)?(?:[_A-Za-z0-9-]|\\.)+/)),t=c.$re(/^[|~*$^]?=/),t&&(r=n.quoted()||c.$re(/^[0-9]+%/)||c.$re(/^[\w-]+/)||n.variableCurly()),o("]"),new tree.Attribute(e,t,r)}},block:function(){var e;if(c.$char("{")&&(e=this.primary())&&c.$char("}"))return e},blockRuleset:function(){var e=this.block();return e&&(e=new tree.Ruleset(null,e)),e},detachedRuleset:function(){var e=this.blockRuleset();if(e)return new tree.DetachedRuleset(e)},ruleset:function(){var e,t,n,a;for(c.save(),r.dumpLineNumbers&&(a=s(c.i));;){if(!(t=this.lessSelector()))break;if(e?e.push(t):e=[t],c.commentStore.length=0,t.condition&&e.length>1&&i("Guards are only currently allowed on a single selector."),!c.$char(","))break;t.condition&&i("Guards are only currently allowed on a single selector."),c.commentStore.length=0}if(e&&(n=this.block())){c.forget();var o=new tree.Ruleset(e,n,r.strictImports);return r.dumpLineNumbers&&(o.debugInfo=a),o}c.restore()},rule:function(e){var t,i,a,o,s,u=c.i,l=c.currentChar();if("."!==l&&"#"!==l&&"&"!==l&&":"!==l)if(c.save(),t=this.variable()||this.ruleProperty()){if(s="string"==typeof t,s&&(i=this.detachedRuleset()),c.commentStore.length=0,!i){o=!s&&t.length>1&&t.pop().value;var f=!e&&(r.compress||s);if(f&&(i=this.value()),!i&&(i=this.anonymousValue()))return c.forget(),new tree.Rule(t,i,!1,o,u,n);f||i||(i=this.value()),a=this.important()}if(i&&this.end())return c.forget(),new tree.Rule(t,i,a,o,u,n);if(c.restore(),i&&!e)return this.rule(!0)}else c.forget()},anonymousValue:function(){var e=c.$re(/^([^@+\/'"*`(;{}-]*);/);if(e)return new tree.Anonymous(e[1])},import:function(){var e,r,t=c.i,a=c.$re(/^@import?\s+/);if(a){var o=(a?this.importOptions():null)||{};if(e=this.entities.quoted()||this.entities.url())return r=this.mediaFeatures(),c.$char(";")||(c.i=t,i("missing semi-colon or unrecognised media features on import")),r=r&&new tree.Value(r),new tree.Import(e,r,o,t,n);c.i=t,i("malformed import statement")}},importOptions:function(){var e,r,t,n={};if(!c.$char("("))return null;do{if(e=this.importOption()){switch(r=e,t=!0,r){case"css":r="less",t=!1;break;case"once":r="multiple",t=!1}if(n[r]=t,!c.$char(","))break}}while(e);return o(")"),n},importOption:function(){var e=c.$re(/^(less|css|multiple|once|inline|reference|optional)/);if(e)return e[1]},mediaFeature:function(){var e,r,t=this.entities,a=[];c.save();do{e=t.keyword()||t.variable(),e?a.push(e):c.$char("(")&&(r=this.property(),e=this.value(),c.$char(")")?r&&e?a.push(new tree.Paren(new tree.Rule(r,e,null,null,c.i,n,!0))):e?a.push(new tree.Paren(e)):i("badly formed media feature definition"):i("Missing closing ')'","Parse"))}while(e);if(c.forget(),a.length>0)return new tree.Expression(a)},mediaFeatures:function(){var e,r=this.entities,t=[];do{if(e=this.mediaFeature()){if(t.push(e),!c.$char(","))break}else if((e=r.variable())&&(t.push(e),!c.$char(",")))break}while(e);return t.length>0?t:null},media:function(){var e,t,a,o,u=c.i;if(r.dumpLineNumbers&&(o=s(u)),c.save(),c.$str("@media"))return e=this.mediaFeatures(),t=this.block(),t||i("media definitions require block statements after any features"),c.forget(),a=new tree.Media(t,e,u,n),r.dumpLineNumbers&&(a.debugInfo=o),a;c.restore()},plugin:function(){var e,r=c.i;if(c.$re(/^@plugin?\s+/)){var t={plugin:!0};if(e=this.entities.quoted()||this.entities.url())return c.$char(";")||(c.i=r,i("missing semi-colon on plugin")),new tree.Import(e,null,t,r,n);c.i=r,i("malformed plugin statement")}},directive:function(){var e,t,a,o,u,l,f,h=c.i,d=!0,m=!0;if("@"===c.currentChar()){if(t=this.import()||this.plugin()||this.media())return t;if(c.save(),e=c.$re(/^@[a-z-]+/)){switch(o=e,"-"==e.charAt(1)&&e.indexOf("-",2)>0&&(o="@"+e.slice(e.indexOf("-",2)+1)),o){case"@charset":u=!0,d=!1;break;case"@namespace":l=!0,d=!1;break;case"@keyframes":case"@counter-style":u=!0;break;case"@document":case"@supports":f=!0,m=!1;break;default:f=!0}if(c.commentStore.length=0,u?(t=this.entity())||i("expected "+e+" identifier"):l?(t=this.expression())||i("expected "+e+" expression"):f&&(t=(c.$re(/^[^{;]+/)||"").trim(),d="{"==c.currentChar(),t&&(t=new tree.Anonymous(t))),d&&(a=this.blockRuleset()),a||!d&&t&&c.$char(";"))return c.forget(),new tree.Directive(e,t,a,h,n,r.dumpLineNumbers?s(h):null,m);c.restore("directive options not recognised")}}},value:function(){var e,r=[];do{if((e=this.expression())&&(r.push(e),!c.$char(",")))break}while(e);if(r.length>0)return new tree.Value(r)},important:function(){if("!"===c.currentChar())return c.$re(/^! *important/)},sub:function(){var e,r;if(c.save(),c.$char("("))return(e=this.addition())&&c.$char(")")?(c.forget(),r=new tree.Expression([e]),r.parens=!0,r):void c.restore("Expected ')'");c.restore()},multiplication:function(){var e,r,t,n,i;if(e=this.operand()){for(i=c.isWhitespace(-1);;){if(c.peek(/^\/[*\/]/))break;if(c.save(),!(t=c.$char("/")||c.$char("*"))){c.forget();break}if(!(r=this.operand())){c.restore();break}c.forget(),e.parensInOp=!0,r.parensInOp=!0,n=new tree.Operation(t,[n||e,r],i),i=c.isWhitespace(-1)}return n||e}},addition:function(){var e,r,t,n,i;if(e=this.multiplication()){for(i=c.isWhitespace(-1);;){if(!(t=c.$re(/^[-+]\s+/)||!i&&(c.$char("+")||c.$char("-"))))break;if(!(r=this.multiplication()))break;e.parensInOp=!0,r.parensInOp=!0,n=new tree.Operation(t,[n||e,r],i),i=c.isWhitespace(-1)}return n||e}},conditions:function(){var e,r,t,n=c.i;if(e=this.condition()){for(;;){if(!c.peek(/^,\s*(not\s*)?\(/)||!c.$char(","))break;if(!(r=this.condition()))break;t=new tree.Condition("or",t||e,r,n)}return t||e}},condition:function(){var e,r,t;if(e=this.conditionAnd(this)){if(r=function(){return c.$str("or")}()){if(!(t=this.condition()))return;e=new tree.Condition(r,e,t)}return e}},conditionAnd:function(){var e,r,t;if(e=function(e){return e.negatedCondition()||e.parenthesisCondition()}(this)){if(r=function(){return c.$str("and")}()){if(!(t=this.conditionAnd()))return;e=new tree.Condition(r,e,t)}return e}},negatedCondition:function(){if(c.$str("not")){var e=this.parenthesisCondition();return e&&(e.negate=!e.negate),e}},parenthesisCondition:function(){var e;return c.save(),c.$str("(")?(e=function(e){var r;return c.save(),(r=e.condition())&&c.$char(")")?(c.forget(),r):void c.restore()}(this))?(c.forget(),e):(e=this.atomicCondition())?c.$char(")")?(c.forget(),e):void c.restore("expected ')' got '"+c.currentChar()+"'"):void c.restore():void c.restore()},atomicCondition:function(){var e,r,t,n,a=this.entities,o=c.i;if(e=this.addition()||a.keyword()||a.quoted())return c.$char(">")?n=c.$char("=")?">=":">":c.$char("<")?n=c.$char("=")?"<=":"<":c.$char("=")&&(n=c.$char(">")?"=>":c.$char("<")?"=<":"="),n?(r=this.addition()||a.keyword()||a.quoted(),r?t=new tree.Condition(n,e,r,o,!1):i("expected expression")):t=new tree.Condition("=",e,new tree.Keyword("true"),o,!1),t},operand:function(){var e,r=this.entities;c.peek(/^-[@\(]/)&&(e=c.$char("-"));var t=this.sub()||r.dimension()||r.color()||r.variable()||r.call()||r.colorKeyword();return e&&(t.parensInOp=!0,t=new tree.Negative(t)),t},expression:function(){var e,r,t=[];do{e=this.comment(),e?t.push(e):(e=this.addition()||this.entity())&&(t.push(e),c.peek(/^\/[\/*]/)||(r=c.$char("/"))&&t.push(new tree.Anonymous(r)))}while(e);if(t.length>0)return new tree.Expression(t)},property:function(){var e=c.$re(/^(\*?-?[_a-zA-Z0-9-]+)\s*:/);if(e)return e[1]},ruleProperty:function(){function e(e){var r=c.i,t=c.$re(e);if(t)return a.push(r),i.push(t[1])}var r,t,i=[],a=[];c.save();var o=c.$re(/^([_a-zA-Z0-9-]+)\s*:/);if(o)return i=[new tree.Keyword(o[1])],c.forget(),i;for(e(/^(\*?)/);;)if(!e(/^((?:[\w-]+)|(?:@\{[\w-]+\}))/))break;if(i.length>1&&e(/^((?:\+_|\+)?)\s*:/)){for(c.forget(),""===i[0]&&(i.shift(),a.shift()),t=0;t<i.length;t++)r=i[t],i[t]="@"!==r.charAt(0)?new tree.Keyword(r):new tree.Variable("@"+r.slice(2,-1),a[t],n);return i}c.restore()}}}};Parser.serializeVars=function(e){var r="";for(var t in e)if(Object.hasOwnProperty.call(e,t)){var n=e[t];r+=("@"===t[0]?"":"@")+t+": "+n+(";"===String(n).slice(-1)?"":";")}return r},module.exports=Parser;
