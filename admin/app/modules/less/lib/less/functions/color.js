function clamp(n){return Math.min(1,Math.max(0,n))}function hsla(n){return colorFunctions.hsla(n.h,n.s,n.l,n.a)}function number(n){if(n instanceof Dimension)return parseFloat(n.unit.is("%")?n.value/100:n.value);if("number"==typeof n)return n;throw{type:"Argument",message:"color functions take numbers as parameters"}}function scaled(n,r){return n instanceof Dimension&&n.unit.is("%")?parseFloat(n.value*r/100):number(n)}var Dimension=require("../tree/dimension"),Color=require("../tree/color"),Quoted=require("../tree/quoted"),Anonymous=require("../tree/anonymous"),functionRegistry=require("./function-registry"),colorFunctions;colorFunctions={rgb:function(n,r,e){return colorFunctions.rgba(n,r,e,1)},rgba:function(n,r,e,o){var t=[n,r,e].map(function(n){return scaled(n,255)});return o=number(o),new Color(t,o)},hsl:function(n,r,e){return colorFunctions.hsla(n,r,e,1)},hsla:function(n,r,e,o){function t(n){return n=n<0?n+1:n>1?n-1:n,6*n<1?u+(a-u)*n*6:2*n<1?a:3*n<2?u+(a-u)*(2/3-n)*6:u}var u,a;return n=number(n)%360/360,r=clamp(number(r)),e=clamp(number(e)),o=clamp(number(o)),a=e<=.5?e*(r+1):e+r-e*r,u=2*e-a,colorFunctions.rgba(255*t(n+1/3),255*t(n),255*t(n-1/3),o)},hsv:function(n,r,e){return colorFunctions.hsva(n,r,e,1)},hsva:function(n,r,e,o){n=number(n)%360/360*360,r=number(r),e=number(e),o=number(o);var t,u;t=Math.floor(n/60%6),u=n/60-t;var a=[e,e*(1-r),e*(1-u*r),e*(1-(1-u)*r)],i=[[0,3,1],[2,0,1],[1,0,3],[1,2,0],[3,1,0],[0,1,2]];return colorFunctions.rgba(255*a[i[t][0]],255*a[i[t][1]],255*a[i[t][2]],o)},hue:function(n){return new Dimension(n.toHSL().h)},saturation:function(n){return new Dimension(100*n.toHSL().s,"%")},lightness:function(n){return new Dimension(100*n.toHSL().l,"%")},hsvhue:function(n){return new Dimension(n.toHSV().h)},hsvsaturation:function(n){return new Dimension(100*n.toHSV().s,"%")},hsvvalue:function(n){return new Dimension(100*n.toHSV().v,"%")},red:function(n){return new Dimension(n.rgb[0])},green:function(n){return new Dimension(n.rgb[1])},blue:function(n){return new Dimension(n.rgb[2])},alpha:function(n){return new Dimension(n.toHSL().a)},luma:function(n){return new Dimension(n.luma()*n.alpha*100,"%")},luminance:function(n){var r=.2126*n.rgb[0]/255+.7152*n.rgb[1]/255+.0722*n.rgb[2]/255;return new Dimension(r*n.alpha*100,"%")},saturate:function(n,r,e){if(!n.rgb)return null;var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.s+=o.s*r.value/100:o.s+=r.value/100,o.s=clamp(o.s),hsla(o)},desaturate:function(n,r,e){var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.s-=o.s*r.value/100:o.s-=r.value/100,o.s=clamp(o.s),hsla(o)},lighten:function(n,r,e){var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.l+=o.l*r.value/100:o.l+=r.value/100,o.l=clamp(o.l),hsla(o)},darken:function(n,r,e){var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.l-=o.l*r.value/100:o.l-=r.value/100,o.l=clamp(o.l),hsla(o)},fadein:function(n,r,e){var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.a+=o.a*r.value/100:o.a+=r.value/100,o.a=clamp(o.a),hsla(o)},fadeout:function(n,r,e){var o=n.toHSL();return void 0!==e&&"relative"===e.value?o.a-=o.a*r.value/100:o.a-=r.value/100,o.a=clamp(o.a),hsla(o)},fade:function(n,r){var e=n.toHSL();return e.a=r.value/100,e.a=clamp(e.a),hsla(e)},spin:function(n,r){var e=n.toHSL(),o=(e.h+r.value)%360;return e.h=o<0?360+o:o,hsla(e)},mix:function(n,r,e){n.toHSL&&r.toHSL||(console.log(r.type),console.dir(r)),e||(e=new Dimension(50));var o=e.value/100,t=2*o-1,u=n.toHSL().a-r.toHSL().a,a=((t*u==-1?t:(t+u)/(1+t*u))+1)/2,i=1-a,l=[n.rgb[0]*a+r.rgb[0]*i,n.rgb[1]*a+r.rgb[1]*i,n.rgb[2]*a+r.rgb[2]*i],s=n.alpha*o+r.alpha*(1-o);return new Color(l,s)},greyscale:function(n){return colorFunctions.desaturate(n,new Dimension(100))},contrast:function(n,r,e,o){if(!n.rgb)return null;void 0===r&&(r=colorFunctions.rgba(0,0,0,1)),void 0===e&&(e=colorFunctions.rgba(255,255,255,1));var t,u,a=n.luma(),i=r.luma(),l=e.luma();return t=a>i?(a+.05)/(i+.05):(i+.05)/(a+.05),u=a>l?(a+.05)/(l+.05):(l+.05)/(a+.05),t>u?r:e},argb:function(n){return new Anonymous(n.toARGB())},color:function(n){if(n instanceof Quoted&&/^#([a-f0-9]{6}|[a-f0-9]{3})$/i.test(n.value))return new Color(n.value.slice(1));if(n instanceof Color||(n=Color.fromKeyword(n.value)))return n.value=void 0,n;throw{type:"Argument",message:"argument must be a color keyword or 3/6 digit hex e.g. #FFF"}},tint:function(n,r){return colorFunctions.mix(colorFunctions.rgb(255,255,255),n,r)},shade:function(n,r){return colorFunctions.mix(colorFunctions.rgb(0,0,0),n,r)}},functionRegistry.addMultiple(colorFunctions);
