var tree=require("../tree"),Visitor=require("./visitor"),CSSVisitorUtils=function(i){this._visitor=new Visitor(this),this._context=i};CSSVisitorUtils.prototype={containsSilentNonBlockedChild:function(i){var e;if(null==i)return!1;for(var t=0;t<i.length;t++)if(e=i[t],e.isSilent&&e.isSilent(this._context)&&!e.blocksVisibility())return!0;return!1},keepOnlyVisibleChilds:function(i){null!=i&&null!=i.rules&&(i.rules=i.rules.filter(function(i){return i.isVisible()}))},isEmpty:function(i){return null==i||null==i.rules||0===i.rules.length},hasVisibleSelector:function(i){return null!=i&&null!=i.paths&&i.paths.length>0},resolveVisibility:function(i,e){if(!i.blocksVisibility()){if(this.isEmpty(i)&&!this.containsSilentNonBlockedChild(e))return;return i}var t=i.rules[0];if(this.keepOnlyVisibleChilds(t),!this.isEmpty(t))return i.ensureVisibility(),i.removeVisibilityBlock(),i},isVisibleRuleset:function(i){return!!i.firstRoot||!this.isEmpty(i)&&!(!i.root&&!this.hasVisibleSelector(i))}};var ToCSSVisitor=function(i){this._visitor=new Visitor(this),this._context=i,this.utils=new CSSVisitorUtils(i)};ToCSSVisitor.prototype={isReplacing:!0,run:function(i){return this._visitor.visit(i)},visitRule:function(i,e){if(!i.blocksVisibility()&&!i.variable)return i},visitMixinDefinition:function(i,e){i.frames=[]},visitExtend:function(i,e){},visitComment:function(i,e){if(!i.blocksVisibility()&&!i.isSilent(this._context))return i},visitMedia:function(i,e){var t=i.rules[0].rules;return i.accept(this._visitor),e.visitDeeper=!1,this.utils.resolveVisibility(i,t)},visitImport:function(i,e){if(!i.blocksVisibility())return i},visitDirective:function(i,e){return i.rules&&i.rules.length?this.visitDirectiveWithBody(i,e):this.visitDirectiveWithoutBody(i,e)},visitDirectiveWithBody:function(i,e){function t(i){var e=i.rules;return 1===e.length&&(!e[0].paths||0===e[0].paths.length)}var n=function(i){var e=i.rules;return t(i)?e[0].rules:e}(i);return i.accept(this._visitor),e.visitDeeper=!1,this.utils.isEmpty(i)||this._mergeRules(i.rules[0].rules),this.utils.resolveVisibility(i,n)},visitDirectiveWithoutBody:function(i,e){if(!i.blocksVisibility()){if("@charset"===i.name){if(this.charset){if(i.debugInfo){var t=new tree.Comment("/* "+i.toCSS(this._context).replace(/\n/g,"")+" */\n");return t.debugInfo=i.debugInfo,this._visitor.visit(t)}return}this.charset=!0}return i}},checkValidNodes:function(i,e){if(i)for(var t=0;t<i.length;t++){var n=i[t];if(e&&n instanceof tree.Rule&&!n.variable)throw{message:"Properties must be inside selector blocks. They cannot be in the root",index:n.index,filename:n.currentFileInfo&&n.currentFileInfo.filename};if(n instanceof tree.Call)throw{message:"Function '"+n.name+"' is undefined",index:n.index,filename:n.currentFileInfo&&n.currentFileInfo.filename};if(n.type&&!n.allowRoot)throw{message:n.type+" node returned by a function is not valid here",index:n.index,filename:n.currentFileInfo&&n.currentFileInfo.filename}}},visitRuleset:function(i,e){var t,n=[];if(this.checkValidNodes(i.rules,i.firstRoot),i.root)i.accept(this._visitor),e.visitDeeper=!1;else{this._compileRulesetPaths(i);for(var s=i.rules,r=s?s.length:0,l=0;l<r;)t=s[l],t&&t.rules?(n.push(this._visitor.visit(t)),s.splice(l,1),r--):l++;r>0?i.accept(this._visitor):i.rules=null,e.visitDeeper=!1}return i.rules&&(this._mergeRules(i.rules),this._removeDuplicateRules(i.rules)),this.utils.isVisibleRuleset(i)&&(i.ensureVisibility(),n.splice(0,0,i)),1===n.length?n[0]:n},_compileRulesetPaths:function(i){i.paths&&(i.paths=i.paths.filter(function(i){var e;for(" "===i[0].elements[0].combinator.value&&(i[0].elements[0].combinator=new tree.Combinator("")),e=0;e<i.length;e++)if(i[e].isVisible()&&i[e].getIsOutput())return!0;return!1}))},_removeDuplicateRules:function(i){if(i){var e,t,n,s={};for(n=i.length-1;n>=0;n--)if((t=i[n])instanceof tree.Rule)if(s[t.name]){e=s[t.name],e instanceof tree.Rule&&(e=s[t.name]=[s[t.name].toCSS(this._context)]);var r=t.toCSS(this._context);-1!==e.indexOf(r)?i.splice(n,1):e.push(r)}else s[t.name]=t}},_mergeRules:function(i){if(i){for(var e,t,n,s={},r=0;r<i.length;r++)(t=i[r])instanceof tree.Rule&&t.merge&&(n=[t.name,t.important?"!":""].join(","),s[n]?i.splice(r--,1):s[n]=[],s[n].push(t));Object.keys(s).map(function(i){function n(i){return new tree.Expression(i.map(function(i){return i.value}))}if(e=s[i],e.length>1){t=e[0];var r=[],l=[];e.map(function(i){"+"===i.merge&&(l.length>0&&r.push(n(l)),l=[]),l.push(i)}),r.push(n(l)),t.value=function(i){return new tree.Value(i.map(function(i){return i}))}(r)}})}},visitAnonymous:function(i,e){if(!i.blocksVisibility())return i.accept(this._visitor),i}},module.exports=ToCSSVisitor;
