var contexts=require("../contexts"),Visitor=require("./visitor"),ImportSequencer=require("./import-sequencer"),ImportVisitor=function(t,i){this._visitor=new Visitor(this),this._importer=t,this._finish=i,this.context=new contexts.Eval,this.importCount=0,this.onceFileDetectionMap={},this.recursionDetector={},this._sequencer=new ImportSequencer(this._onSequencerEmpty.bind(this))};ImportVisitor.prototype={isReplacing:!1,run:function(t){try{this._visitor.visit(t)}catch(t){this.error=t}this.isFinished=!0,this._sequencer.tryRun()},_onSequencerEmpty:function(){this.isFinished&&this._finish(this.error)},visitImport:function(t,i){var e=t.options.inline;if(!t.css||e){var s=new contexts.Eval(this.context,this.context.frames.slice(0)),n=s.frames[0];this.importCount++,t.isVariableImport()?this._sequencer.addVariableImport(this.processImportNode.bind(this,t,s,n)):this.processImportNode(t,s,n)}i.visitDeeper=!1},processImportNode:function(t,i,e){var s,n=t.options.inline;try{s=t.evalForImport(i)}catch(i){i.filename||(i.index=t.index,i.filename=t.currentFileInfo.filename),t.css=!0,t.error=i}if(!s||s.css&&!n)this.importCount--,this.isFinished&&this._sequencer.tryRun();else{s.options.multiple&&(i.importMultiple=!0);for(var o=void 0===s.css,r=0;r<e.rules.length;r++)if(e.rules[r]===t){e.rules[r]=s;break}var c=this.onImported.bind(this,s,i),u=this._sequencer.addImport(c);this._importer.push(s.getPath(),o,s.currentFileInfo,s.options,u)}},onImported:function(t,i,e,s,n,o){e&&(e.filename||(e.index=t.index,e.filename=t.currentFileInfo.filename),this.error=e);var r=this,c=t.options.inline,u=t.options.plugin,h=t.options.optional,p=n||o in r.recursionDetector;if(i.importMultiple||(t.skip=!!p||function(){return o in r.onceFileDetectionMap||(r.onceFileDetectionMap[o]=!0,!1)}),!o&&h&&(t.skip=!0),s&&(t.root=s,t.importedFilename=o,!c&&!u&&(i.importMultiple||!p))){r.recursionDetector[o]=!0;var f=this.context;this.context=i;try{this._visitor.visit(s)}catch(e){this.error=e}this.context=f}r.importCount--,r.isFinished&&r._sequencer.tryRun()},visitRule:function(t,i){"DetachedRuleset"===t.value.type?this.context.frames.unshift(t):i.visitDeeper=!1},visitRuleOut:function(t){"DetachedRuleset"===t.value.type&&this.context.frames.shift()},visitDirective:function(t,i){this.context.frames.unshift(t)},visitDirectiveOut:function(t){this.context.frames.shift()},visitMixinDefinition:function(t,i){this.context.frames.unshift(t)},visitMixinDefinitionOut:function(t){this.context.frames.shift()},visitRuleset:function(t,i){this.context.frames.unshift(t)},visitRulesetOut:function(t){this.context.frames.shift()},visitMedia:function(t,i){this.context.frames.unshift(t.rules[0])},visitMediaOut:function(t){this.context.frames.shift()}},module.exports=ImportVisitor;
