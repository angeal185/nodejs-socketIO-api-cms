var tree=require("../tree"),Visitor=require("./visitor"),logger=require("../logger"),ExtendFinderVisitor=function(){this._visitor=new Visitor(this),this.contexts=[],this.allExtendsStack=[[]]};ExtendFinderVisitor.prototype={run:function(e){return e=this._visitor.visit(e),e.allExtends=this.allExtendsStack[0],e},visitRule:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,s,l,a=[],r=e.rules,c=r?r.length:0;for(n=0;n<c;n++)e.rules[n]instanceof tree.Extend&&(a.push(r[n]),e.extendOnEveryPath=!0);var o=e.paths;for(n=0;n<o.length;n++){var h=o[n],d=h[h.length-1],u=d.extendList;for(l=u?u.slice(0).concat(a):a,l&&(l=l.map(function(e){return e.clone()})),i=0;i<l.length;i++)this.foundExtends=!0,s=l[i],s.findSelfSelectors(h),s.ruleset=e,0===i&&(s.firstExtendOnThisSelectorPath=!0),this.allExtendsStack[this.allExtendsStack.length-1].push(s)}this.contexts.push(e.selectors)}},visitRulesetOut:function(e){e.root||(this.contexts.length=this.contexts.length-1)},visitMedia:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitMediaOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1},visitDirective:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitDirectiveOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1}};var ProcessExtendsVisitor=function(){this._visitor=new Visitor(this)};ProcessExtendsVisitor.prototype={run:function(e){var t=new ExtendFinderVisitor;if(this.extendIndices={},t.run(e),!t.foundExtends)return e;e.allExtends=e.allExtends.concat(this.doExtendChaining(e.allExtends,e.allExtends)),this.allExtendsStack=[e.allExtends];var n=this._visitor.visit(e);return this.checkExtendsForNonMatched(e.allExtends),n},checkExtendsForNonMatched:function(e){var t=this.extendIndices;e.filter(function(e){return!e.hasFoundMatches&&1==e.parent_ids.length}).forEach(function(e){var n="_unknown_";try{n=e.selector.toCSS({})}catch(e){}t[e.index+" "+n]||(t[e.index+" "+n]=!0,logger.warn("extend '"+n+"' has no matches"))})},doExtendChaining:function(e,t,n){var i,s,l,a,r,c,o,h,d=[],u=this;for(n=n||0,i=0;i<e.length;i++)for(s=0;s<t.length;s++)c=e[i],o=t[s],c.parent_ids.indexOf(o.object_id)>=0||(r=[o.selfSelectors[0]],l=u.findMatch(c,r),l.length&&(c.hasFoundMatches=!0,c.selfSelectors.forEach(function(e){var t=o.visibilityInfo();a=u.extendSelector(l,r,e,c.isVisible()),h=new tree.Extend(o.selector,o.option,0,o.currentFileInfo,t),h.selfSelectors=a,a[a.length-1].extendList=[h],d.push(h),h.ruleset=o.ruleset,h.parent_ids=h.parent_ids.concat(o.parent_ids,c.parent_ids),o.firstExtendOnThisSelectorPath&&(h.firstExtendOnThisSelectorPath=!0,o.ruleset.paths.push(a))})));if(d.length){if(this.extendChainCount++,n>100){var x="{unable to calculate}",f="{unable to calculate}";try{x=d[0].selfSelectors[0].toCSS(),f=d[0].selector.toCSS()}catch(e){}throw{message:"extend circular reference detected. One of the circular extends is currently:"+x+":extend("+f+")"}}return d.concat(u.doExtendChaining(d,t,n+1))}return d},visitRule:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitSelector:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,s,l,a=this.allExtendsStack[this.allExtendsStack.length-1],r=[],c=this;for(s=0;s<a.length;s++)for(i=0;i<e.paths.length;i++)if(l=e.paths[i],!e.extendOnEveryPath){var o=l[l.length-1].extendList;o&&o.length||(n=this.findMatch(a[s],l),n.length&&(a[s].hasFoundMatches=!0,a[s].selfSelectors.forEach(function(e){var t;t=c.extendSelector(n,l,e,a[s].isVisible()),r.push(t)})))}e.paths=e.paths.concat(r)}},findMatch:function(e,t){var n,i,s,l,a,r,c,o=this,h=e.selector.elements,d=[],u=[];for(n=0;n<t.length;n++)for(i=t[n],s=0;s<i.elements.length;s++)for(l=i.elements[s],(e.allowBefore||0===n&&0===s)&&d.push({pathIndex:n,index:s,matched:0,initialCombinator:l.combinator}),r=0;r<d.length;r++)c=d[r],a=l.combinator.value,""===a&&0===s&&(a=" "),!o.isElementValuesEqual(h[c.matched].value,l.value)||c.matched>0&&h[c.matched].combinator.value!==a?c=null:c.matched++,c&&(c.finished=c.matched===h.length,c.finished&&!e.allowAfter&&(s+1<i.elements.length||n+1<t.length)&&(c=null)),c?c.finished&&(c.length=h.length,c.endPathIndex=n,c.endPathElementIndex=s+1,d.length=0,u.push(c)):(d.splice(r,1),r--);return u},isElementValuesEqual:function(e,t){if("string"==typeof e||"string"==typeof t)return e===t;if(e instanceof tree.Attribute)return e.op===t.op&&e.key===t.key&&(e.value&&t.value?(e=e.value.value||e.value,t=t.value.value||t.value,e===t):!e.value&&!t.value);if(e=e.value,t=t.value,e instanceof tree.Selector){if(!(t instanceof tree.Selector)||e.elements.length!==t.elements.length)return!1;for(var n=0;n<e.elements.length;n++){if(e.elements[n].combinator.value!==t.elements[n].combinator.value&&(0!==n||(e.elements[n].combinator.value||" ")!==(t.elements[n].combinator.value||" ")))return!1;if(!this.isElementValuesEqual(e.elements[n].value,t.elements[n].value))return!1}return!0}return!1},extendSelector:function(e,t,n,i){var s,l,a,r,c,o=0,h=0,d=[];for(s=0;s<e.length;s++)r=e[s],l=t[r.pathIndex],a=new tree.Element(r.initialCombinator,n.elements[0].value,n.elements[0].index,n.elements[0].currentFileInfo),r.pathIndex>o&&h>0&&(d[d.length-1].elements=d[d.length-1].elements.concat(t[o].elements.slice(h)),h=0,o++),c=l.elements.slice(h,r.index).concat([a]).concat(n.elements.slice(1)),o===r.pathIndex&&s>0?d[d.length-1].elements=d[d.length-1].elements.concat(c):(d=d.concat(t.slice(o,r.pathIndex)),d.push(new tree.Selector(c))),o=r.endPathIndex,(h=r.endPathElementIndex)>=t[o].elements.length&&(h=0,o++);return o<t.length&&h>0&&(d[d.length-1].elements=d[d.length-1].elements.concat(t[o].elements.slice(h)),o++),d=d.concat(t.slice(o,t.length)),d=d.map(function(e){var t=e.createDerived(e.elements);return i?t.ensureVisibility():t.ensureInvisibility(),t})},visitMedia:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitMediaOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t},visitDirective:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitDirectiveOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t}},module.exports=ProcessExtendsVisitor;
