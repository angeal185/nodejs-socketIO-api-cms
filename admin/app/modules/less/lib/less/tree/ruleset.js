var Node=require("./node"),Rule=require("./rule"),Selector=require("./selector"),Element=require("./element"),Paren=require("./paren"),contexts=require("../contexts"),globalFunctionRegistry=require("../functions/function-registry"),defaultFunc=require("../functions/default"),getDebugInfo=require("./debug-info"),Ruleset=function(e,t,r,s){this.selectors=e,this.rules=t,this._lookups={},this.strictImports=r,this.copyVisibilityInfo(s),this.allowRoot=!0};Ruleset.prototype=new Node,Ruleset.prototype.type="Ruleset",Ruleset.prototype.isRuleset=!0,Ruleset.prototype.isRulesetLike=!0,Ruleset.prototype.accept=function(e){this.paths?this.paths=e.visitArray(this.paths,!0):this.selectors&&(this.selectors=e.visitArray(this.selectors)),this.rules&&this.rules.length&&(this.rules=e.visitArray(this.rules))},Ruleset.prototype.eval=function(e){var t,r,s,l,n=this.selectors,i=!1;if(n&&(r=n.length)){for(t=[],defaultFunc.error({type:"Syntax",message:"it is currently only allowed in parametric mixin guards,"}),l=0;l<r;l++)s=n[l].eval(e),t.push(s),s.evaldCondition&&(i=!0);defaultFunc.reset()}else i=!0;var o,u,a=this.rules?this.rules.slice(0):null,h=new Ruleset(t,a,this.strictImports,this.visibilityInfo());h.originalRuleset=this,h.root=this.root,h.firstRoot=this.firstRoot,h.allowImports=this.allowImports,this.debugInfo&&(h.debugInfo=this.debugInfo),i||(a.length=0),h.functionRegistry=function(e){for(var t,r=0,s=e.length;r!==s;++r)if(t=e[r].functionRegistry)return t;return globalFunctionRegistry}(e.frames).inherit();var c=e.frames;c.unshift(h);var p=e.selectors;p||(e.selectors=p=[]),p.unshift(this.selectors),(h.root||h.allowImports||!h.strictImports)&&h.evalImports(e);var f=h.rules,v=f?f.length:0;for(l=0;l<v;l++)f[l].evalFirst&&(f[l]=f[l].eval(e));var g=e.mediaBlocks&&e.mediaBlocks.length||0;for(l=0;l<v;l++)"MixinCall"===f[l].type?(a=f[l].eval(e).filter(function(e){return!(e instanceof Rule&&e.variable)||!h.variable(e.name)}),f.splice.apply(f,[l,1].concat(a)),v+=a.length-1,l+=a.length-1,h.resetCache()):"RulesetCall"===f[l].type&&(a=f[l].eval(e).rules.filter(function(e){return!(e instanceof Rule&&e.variable)}),f.splice.apply(f,[l,1].concat(a)),v+=a.length-1,l+=a.length-1,h.resetCache());for(l=0;l<f.length;l++)o=f[l],o.evalFirst||(f[l]=o=o.eval?o.eval(e):o);for(l=0;l<f.length;l++)if((o=f[l])instanceof Ruleset&&o.selectors&&1===o.selectors.length&&o.selectors[0].isJustParentSelector()){f.splice(l--,1);for(var m=0;m<o.rules.length;m++)u=o.rules[m],u.copyVisibilityInfo(o.visibilityInfo()),u instanceof Rule&&u.variable||f.splice(++l,0,u)}if(c.shift(),p.shift(),e.mediaBlocks)for(l=g;l<e.mediaBlocks.length;l++)e.mediaBlocks[l].bubbleSelectors(t);return h},Ruleset.prototype.evalImports=function(e){var t,r,s=this.rules;if(s)for(t=0;t<s.length;t++)"Import"===s[t].type&&(r=s[t].eval(e),r&&(r.length||0===r.length)?(s.splice.apply(s,[t,1].concat(r)),t+=r.length-1):s.splice(t,1,r),this.resetCache())},Ruleset.prototype.makeImportant=function(){return new Ruleset(this.selectors,this.rules.map(function(e){return e.makeImportant?e.makeImportant():e}),this.strictImports,this.visibilityInfo())},Ruleset.prototype.matchArgs=function(e){return!e||0===e.length},Ruleset.prototype.matchCondition=function(e,t){var r=this.selectors[this.selectors.length-1];return!!r.evaldCondition&&!(r.condition&&!r.condition.eval(new contexts.Eval(t,t.frames)))},Ruleset.prototype.resetCache=function(){this._rulesets=null,this._variables=null,this._lookups={}},Ruleset.prototype.variables=function(){return this._variables||(this._variables=this.rules?this.rules.reduce(function(e,t){if(t instanceof Rule&&!0===t.variable&&(e[t.name]=t),"Import"===t.type&&t.root&&t.root.variables){var r=t.root.variables();for(var s in r)r.hasOwnProperty(s)&&(e[s]=r[s])}return e},{}):{}),this._variables},Ruleset.prototype.variable=function(e){return this.variables()[e]},Ruleset.prototype.rulesets=function(){if(!this.rules)return[];var e,t,r=[],s=this.rules,l=s.length;for(e=0;e<l;e++)t=s[e],t.isRuleset&&r.push(t);return r},Ruleset.prototype.prependRule=function(e){var t=this.rules;t?t.unshift(e):this.rules=[e]},Ruleset.prototype.find=function(e,t,r){t=t||this;var s,l,n=[],i=e.toCSS();return i in this._lookups?this._lookups[i]:(this.rulesets().forEach(function(i){if(i!==t)for(var o=0;o<i.selectors.length;o++)if(s=e.match(i.selectors[o])){if(e.elements.length>s){if(!r||r(i)){l=i.find(new Selector(e.elements.slice(s)),t,r);for(var u=0;u<l.length;++u)l[u].path.push(i);Array.prototype.push.apply(n,l)}}else n.push({rule:i,path:[]});break}}),this._lookups[i]=n,n)},Ruleset.prototype.genCSS=function(e,t){var r,s,l,n,i,o=[],u=[];e.tabLevel=e.tabLevel||0,this.root||e.tabLevel++;var a,h=e.compress?"":Array(e.tabLevel+1).join("  "),c=e.compress?"":Array(e.tabLevel).join("  "),p=0,f=0;for(r=0;r<this.rules.length;r++)n=this.rules[r],"Comment"===n.type?(f===r&&f++,u.push(n)):n.isCharset&&n.isCharset()?(u.splice(p,0,n),p++,f++):"Import"===n.type?(u.splice(f,0,n),f++):u.push(n);if(u=o.concat(u),!this.root){l=getDebugInfo(e,this,c),l&&(t.add(l),t.add(c));var v,g=this.paths,m=g.length;for(a=e.compress?",":",\n"+c,r=0;r<m;r++)if(i=g[r],v=i.length)for(r>0&&t.add(a),e.firstSelector=!0,i[0].genCSS(e,t),e.firstSelector=!1,s=1;s<v;s++)i[s].genCSS(e,t);t.add((e.compress?"{":" {\n")+h)}for(r=0;r<u.length;r++){n=u[r],r+1===u.length&&(e.lastRule=!0);var y=e.lastRule;(function(e){return"boolean"==typeof e.isRulesetLike?e.isRulesetLike:"function"==typeof e.isRulesetLike&&e.isRulesetLike()})(n)&&(e.lastRule=!1),n.genCSS?n.genCSS(e,t):n.value&&t.add(n.value.toString()),e.lastRule=y,e.lastRule?e.lastRule=!1:t.add(e.compress?"":"\n"+h)}this.root||(t.add(e.compress?"}":"\n"+c+"}"),e.tabLevel--),t.isEmpty()||e.compress||!this.firstRoot||t.add("\n")},Ruleset.prototype.joinSelectors=function(e,t,r){for(var s=0;s<r.length;s++)this.joinSelector(e,t,r[s])},Ruleset.prototype.joinSelector=function(e,t,r){function s(e,t){var r,s;if(0===e.length)r=new Paren(e[0]);else{var l=[];for(s=0;s<e.length;s++)l.push(new Element(null,e[s],t.index,t.currentFileInfo));r=new Paren(new Selector(l))}return r}function l(e,t){var r;return r=new Element(null,e,t.index,t.currentFileInfo),new Selector([r])}function n(e,t,r,s){var l,n,i;if(l=[],e.length>0?(l=e.slice(0),n=l.pop(),i=s.createDerived(n.elements.slice(0))):i=s.createDerived([]),t.length>0){var o=r.combinator,u=t[0].elements[0];o.emptyOrWhitespace&&!u.combinator.emptyOrWhitespace&&(o=u.combinator),i.elements.push(new Element(o,u.value,r.index,r.currentFileInfo)),i.elements=i.elements.concat(t[0].elements.slice(1))}if(0!==i.elements.length&&l.push(i),t.length>1){var a=t.slice(1);a=a.map(function(e){return e.createDerived(e.elements,[])}),l=l.concat(a)}return l}function i(e,t,r,s,l){var i;for(i=0;i<e.length;i++){var o=n(e[i],t,r,s);l.push(o)}return l}function o(e,t){var r,s;if(0!==e.length){if(0===t.length)return void t.push([new Selector(e)]);for(r=0;r<t.length;r++)s=t[r],s.length>0?s[s.length-1]=s[s.length-1].createDerived(s[s.length-1].elements.concat(e)):s.push(new Selector(e))}}function u(e,t,r){var a,h,c,p,f,v,g,m,y,d,R=!1;for(p=[],f=[[]],a=0;a<r.elements.length;a++)if(m=r.elements[a],"&"!==m.value){var b=function(e){var t;return"Paren"!==e.value.type?null:(t=e.value.value,"Selector"!==t.type?null:t)}(m);if(null!=b){o(p,f);var I,S=[],w=[];for(I=u(S,t,b),R=R||I,c=0;c<S.length;c++){var k=l(s(S[c],m),m);i(f,[k],m,r,w)}f=w,p=[]}else p.push(m)}else{for(R=!0,v=[],o(p,f),h=0;h<f.length;h++)if(g=f[h],0===t.length)g.length>0&&g[0].elements.push(new Element(m.combinator,"",m.index,m.currentFileInfo)),v.push(g);else for(c=0;c<t.length;c++){var C=n(g,t[c],m,r);v.push(C)}f=v,p=[]}for(o(p,f),a=0;a<f.length;a++)(y=f[a].length)>0&&(e.push(f[a]),d=f[a][y-1],f[a][y-1]=d.createDerived(d.elements,r.extendList));return R}function a(e,t){var r=t.createDerived(t.elements,t.extendList,t.evaldCondition);return r.copyVisibilityInfo(e),r}var h,c;if(c=[],!u(c,t,r))if(t.length>0)for(c=[],h=0;h<t.length;h++){var p=t[h].map(a.bind(this,r.visibilityInfo()));p.push(r),c.push(p)}else c=[[r]];for(h=0;h<c.length;h++)e.push(c[h])},module.exports=Ruleset;
