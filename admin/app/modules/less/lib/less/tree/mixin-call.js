var Node=require("./node"),Selector=require("./selector"),MixinDefinition=require("./mixin-definition"),defaultFunc=require("../functions/default"),MixinCall=function(e,i,t,n,r){this.selector=new Selector(e),this.arguments=i||[],this.index=t,this.currentFileInfo=n,this.important=r,this.allowRoot=!0};MixinCall.prototype=new Node,MixinCall.prototype.type="MixinCall",MixinCall.prototype.accept=function(e){this.selector&&(this.selector=e.visit(this.selector)),this.arguments.length&&(this.arguments=e.visitArray(this.arguments))},MixinCall.prototype.eval=function(e){var i,t,n,r,l,o,a,s,u,f,h,m,c,p,g,d=[],x=[],y=!1,v=[],C=[],M=-1,S=0,w=1,b=2;for(o=0;o<this.arguments.length;o++)if(r=this.arguments[o],l=r.value.eval(e),r.expand&&Array.isArray(l.value))for(l=l.value,a=0;a<l.length;a++)d.push({value:l[a]});else d.push({name:r.name,value:l});for(g=function(i){return i.matchArgs(null,e)},o=0;o<e.frames.length;o++)if((i=e.frames[o].find(this.selector,null,g)).length>0){for(f=!0,a=0;a<i.length;a++){for(t=i[a].rule,n=i[a].path,u=!1,s=0;s<e.frames.length;s++)if(!(t instanceof MixinDefinition)&&t===(e.frames[s].originalRuleset||e.frames[s])){u=!0;break}u||t.matchArgs(d,e)&&(h={mixin:t,group:function(i,t){var n,r,l;for(n=0;n<2;n++){for(C[n]=!0,defaultFunc.value(n),r=0;r<t.length&&C[n];r++)l=t[r],l.matchCondition&&(C[n]=C[n]&&l.matchCondition(null,e));i.matchCondition&&(C[n]=C[n]&&i.matchCondition(d,e))}return C[0]||C[1]?C[0]!=C[1]?C[1]?w:b:S:M}(t,n)},h.group!==M&&v.push(h),y=!0)}for(defaultFunc.reset(),c=[0,0,0],a=0;a<v.length;a++)c[v[a].group]++;if(c[S]>0)m=b;else if(m=w,c[w]+c[b]>1)throw{type:"Runtime",message:"Ambiguous use of `default()` found when matching for `"+this.format(d)+"`",index:this.index,filename:this.currentFileInfo.filename};for(a=0;a<v.length;a++)if((h=v[a].group)===S||h===m)try{t=v[a].mixin,t instanceof MixinDefinition||(p=t.originalRuleset||t,t=new MixinDefinition("",[],t.rules,null,!1,null,p.visibilityInfo()),t.originalRuleset=p);var F=t.evalCall(e,d,this.important).rules;this._setVisibilityToReplacement(F),Array.prototype.push.apply(x,F)}catch(e){throw{message:e.message,index:this.index,filename:this.currentFileInfo.filename,stack:e.stack}}if(y)return x}throw f?{type:"Runtime",message:"No matching definition was found for `"+this.format(d)+"`",index:this.index,filename:this.currentFileInfo.filename}:{type:"Name",message:this.selector.toCSS().trim()+" is undefined",index:this.index,filename:this.currentFileInfo.filename}},MixinCall.prototype._setVisibilityToReplacement=function(e){var i,t;if(this.blocksVisibility())for(i=0;i<e.length;i++)t=e[i],t.addVisibilityBlock()},MixinCall.prototype.format=function(e){return this.selector.toCSS().trim()+"("+(e?e.map(function(e){var i="";return e.name&&(i+=e.name+":"),e.value.toCSS?i+=e.value.toCSS():i+="???",i}).join(", "):"")+")"},module.exports=MixinCall;
