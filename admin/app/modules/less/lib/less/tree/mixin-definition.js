var Selector=require("./selector"),Element=require("./element"),Ruleset=require("./ruleset"),Rule=require("./rule"),Expression=require("./expression"),contexts=require("../contexts"),Definition=function(e,t,i,n,r,s,a){this.name=e,this.selectors=[new Selector([new Element(null,e,this.index,this.currentFileInfo)])],this.params=t,this.condition=n,this.variadic=r,this.arity=t.length,this.rules=i,this._lookups={};var o=[];this.required=t.reduce(function(e,t){return!t.name||t.name&&!t.value?e+1:(o.push(t.name),e)},0),this.optionalParameters=o,this.frames=s,this.copyVisibilityInfo(a),this.allowRoot=!0};Definition.prototype=new Ruleset,Definition.prototype.type="MixinDefinition",Definition.prototype.evalFirst=!0,Definition.prototype.accept=function(e){this.params&&this.params.length&&(this.params=e.visitArray(this.params)),this.rules=e.visitArray(this.rules),this.condition&&(this.condition=e.visit(this.condition))},Definition.prototype.evalParams=function(e,t,i,n){var r,s,a,o,l,u,h,f,m=new Ruleset(null,null),c=this.params.slice(0),p=0;if(t.frames&&t.frames[0]&&t.frames[0].functionRegistry&&(m.functionRegistry=t.frames[0].functionRegistry.inherit()),t=new contexts.Eval(t,[m].concat(t.frames)),i)for(i=i.slice(0),p=i.length,a=0;a<p;a++)if(s=i[a],u=s&&s.name){for(h=!1,o=0;o<c.length;o++)if(!n[o]&&u===c[o].name){n[o]=s.value.eval(e),m.prependRule(new Rule(u,s.value.eval(e))),h=!0;break}if(h){i.splice(a,1),a--;continue}throw{type:"Runtime",message:"Named argument for "+this.name+" "+i[a].name+" not found"}}for(f=0,a=0;a<c.length;a++)if(!n[a]){if(s=i&&i[f],u=c[a].name)if(c[a].variadic){for(r=[],o=f;o<p;o++)r.push(i[o].value.eval(e));m.prependRule(new Rule(u,new Expression(r).eval(e)))}else{if(l=s&&s.value)l=l.eval(e);else{if(!c[a].value)throw{type:"Runtime",message:"wrong number of arguments for "+this.name+" ("+p+" for "+this.arity+")"};l=c[a].value.eval(t),m.resetCache()}m.prependRule(new Rule(u,l)),n[a]=l}if(c[a].variadic&&i)for(o=f;o<p;o++)n[o]=i[o].value.eval(e);f++}return m},Definition.prototype.makeImportant=function(){var e=this.rules?this.rules.map(function(e){return e.makeImportant?e.makeImportant(!0):e}):this.rules;return new Definition(this.name,this.params,e,this.condition,this.variadic,this.frames)},Definition.prototype.eval=function(e){return new Definition(this.name,this.params,this.rules,this.condition,this.variadic,this.frames||e.frames.slice(0))},Definition.prototype.evalCall=function(e,t,i){var n,r,s=[],a=this.frames?this.frames.concat(e.frames):e.frames,o=this.evalParams(e,new contexts.Eval(e,a),t,s);return o.prependRule(new Rule("@arguments",new Expression(s).eval(e))),n=this.rules.slice(0),r=new Ruleset(null,n),r.originalRuleset=this,r=r.eval(new contexts.Eval(e,[this,o].concat(a))),i&&(r=r.makeImportant()),r},Definition.prototype.matchCondition=function(e,t){return!(this.condition&&!this.condition.eval(new contexts.Eval(t,[this.evalParams(t,new contexts.Eval(t,this.frames?this.frames.concat(t.frames):t.frames),e,[])].concat(this.frames||[]).concat(t.frames))))},Definition.prototype.matchArgs=function(e,t){var i,n=e&&e.length||0,r=this.optionalParameters,s=e?e.reduce(function(e,t){return r.indexOf(t.name)<0?e+1:e},0):0;if(this.variadic){if(s<this.required-1)return!1}else{if(s<this.required)return!1;if(n>this.params.length)return!1}i=Math.min(s,this.arity);for(var a=0;a<i;a++)if(!this.params[a].name&&!this.params[a].variadic&&e[a].value.eval(t).toCSS()!=this.params[a].value.eval(t).toCSS())return!1;return!0},module.exports=Definition;
