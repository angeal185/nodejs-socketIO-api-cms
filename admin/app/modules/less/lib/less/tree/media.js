var Ruleset=require("./ruleset"),Value=require("./value"),Selector=require("./selector"),Anonymous=require("./anonymous"),Expression=require("./expression"),Directive=require("./directive"),Media=function(e,t,i,r,s){this.index=i,this.currentFileInfo=r;var n=new Selector([],null,null,this.index,this.currentFileInfo).createEmptySelectors();this.features=new Value(t),this.rules=[new Ruleset(n,e)],this.rules[0].allowImports=!0,this.copyVisibilityInfo(s),this.allowRoot=!0};Media.prototype=new Directive,Media.prototype.type="Media",Media.prototype.isRulesetLike=!0,Media.prototype.accept=function(e){this.features&&(this.features=e.visit(this.features)),this.rules&&(this.rules=e.visitArray(this.rules))},Media.prototype.genCSS=function(e,t){t.add("@media ",this.currentFileInfo,this.index),this.features.genCSS(e,t),this.outputRuleset(e,t,this.rules)},Media.prototype.eval=function(e){e.mediaBlocks||(e.mediaBlocks=[],e.mediaPath=[]);var t=new Media(null,[],this.index,this.currentFileInfo,this.visibilityInfo());this.debugInfo&&(this.rules[0].debugInfo=this.debugInfo,t.debugInfo=this.debugInfo);var i=!1;e.strictMath||(i=!0,e.strictMath=!0);try{t.features=this.features.eval(e)}finally{i&&(e.strictMath=!1)}return e.mediaPath.push(t),e.mediaBlocks.push(t),this.rules[0].functionRegistry=e.frames[0].functionRegistry.inherit(),e.frames.unshift(this.rules[0]),t.rules=[this.rules[0].eval(e)],e.frames.shift(),e.mediaPath.pop(),0===e.mediaPath.length?t.evalTop(e):t.evalNested(e)},Media.prototype.evalTop=function(e){var t=this;if(e.mediaBlocks.length>1){var i=new Selector([],null,null,this.index,this.currentFileInfo).createEmptySelectors();t=new Ruleset(i,e.mediaBlocks),t.multiMedia=!0,t.copyVisibilityInfo(this.visibilityInfo())}return delete e.mediaBlocks,delete e.mediaPath,t},Media.prototype.evalNested=function(e){var t,i,r=e.mediaPath.concat([this]);for(t=0;t<r.length;t++)i=r[t].features instanceof Value?r[t].features.value:r[t].features,r[t]=Array.isArray(i)?i:[i];return this.features=new Value(this.permute(r).map(function(e){for(e=e.map(function(e){return e.toCSS?e:new Anonymous(e)}),t=e.length-1;t>0;t--)e.splice(t,0,new Anonymous("and"));return new Expression(e)})),new Ruleset([],[])},Media.prototype.permute=function(e){if(0===e.length)return[];if(1===e.length)return e[0];for(var t=[],i=this.permute(e.slice(1)),r=0;r<i.length;r++)for(var s=0;s<e[0].length;s++)t.push([e[0][s]].concat(i[r]));return t},Media.prototype.bubbleSelectors=function(e){e&&(this.rules=[new Ruleset(e.slice(0),[this.rules[0]])])},module.exports=Media;
