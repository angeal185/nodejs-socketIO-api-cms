var Compiler=require("../visitor/compiler"),events=require("../renderer").events,nodes=require("../nodes"),parse=require("url").parse,extname=require("path").extname,utils=require("../utils"),fs=require("fs"),defaultMimes={".gif":"image/gif",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".svg":"image/svg+xml",".webp":"image/webp",".ttf":"application/x-font-ttf",".eot":"application/vnd.ms-fontobject",".woff":"application/font-woff",".woff2":"application/font-woff2"},encodingTypes={BASE_64:"base64",UTF8:"charset=utf-8"};module.exports=function(e){function t(e,t){var a=new Compiler(e),o=encodingTypes.BASE_64;a.isURL=!0,e=e.nodes.map(function(e){return a.visit(e)}).join(""),e=parse(e);var s,p,l=extname(e.pathname),u=n[l],f=e.hash||"",m=new nodes.Literal('url("'+e.href+'")'),g=i.concat(this.paths);if(!u)return m;if(e.protocol)return m;var c=utils.lookup(e.pathname,g);return c?(s=fs.readFileSync(c),!1!==r&&s.length>r?m:(t&&"utf8"==t.first.val.toLowerCase()?(o=encodingTypes.UTF8,p=s.toString("utf8").replace(/\s+/g," ").replace(/[{}\|\\\^~\[\]`"<>#%]/g,function(e){return"%"+e[0].charCodeAt(0).toString(16).toUpperCase()}).trim()):p=s.toString(o)+f,new nodes.Literal('url("data:'+u+";"+o+","+p+'")'))):(events.emit("file not found","File "+m+" could not be found, literal url retained!"),m)}e=e||{};var i=e.paths||[],r=null!=e.limit?e.limit:3e4,n=e.mimes||defaultMimes;return t.raw=!0,t},module.exports.mimes=defaultMimes;
