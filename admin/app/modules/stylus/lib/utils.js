var nodes=require("./nodes"),basename=require("path").basename,relative=require("path").relative,join=require("path").join,isAbsolute=require("path").isAbsolute,glob=require("glob"),fs=require("fs");exports.absolute=isAbsolute||function(e){return"\\\\"==e.substr(0,2)||"/"===e.charAt(0)||/^[a-z]:[\\\/]/i.test(e)},exports.lookup=function(e,r,n){var t,o=r.length;if(exports.absolute(e))try{return fs.statSync(e),e}catch(e){}for(;o--;)try{if(t=join(r[o],e),n==t)continue;return fs.statSync(t),t}catch(e){}},exports.find=function(e,r,n){var t,o,s=r.length;if(exports.absolute(e)&&(o=glob.sync(e)).length)return o;for(;s--;)if(t=join(r[s],e),n!=t&&(o=glob.sync(t)).length)return o},exports.lookupIndex=function(e,r,n){function t(e){var s=exports.lookup(join(e,"package.json"),r,n);if(!s)return/\.styl$/i.test(e)?exports.lookupIndex(e,r,n):t(e+".styl");var a=require(relative(__dirname,s)).main;return o=a?exports.find(join(e,a),r,n):exports.lookupIndex(e,r,n)}var o=exports.find(join(e,"index.styl"),r,n);return o||(o=exports.find(join(e,basename(e).replace(/\.styl/i,"")+".styl"),r,n)),o||~e.indexOf("node_modules")||(o=t(join("node_modules",e))),o},exports.formatException=function(e,r){var n=r.lineno,t=r.column,o=r.filename,s=r.input,a=r.context||8,a=a/2,i=("\n"+s).split("\n"),u=Math.max(n-a,1),c=Math.min(i.length,n+a),p=c.toString().length,a=i.slice(u,c).map(function(e,r){var o=r+u;return"   "+Array(p-o.toString().length+1).join(" ")+o+"| "+e+(o==n?"\n"+Array(o.toString().length+5+t).join("-")+"^":"")}).join("\n");return e.message=o+":"+n+":"+t+"\n"+a+"\n\n"+e.message+"\n"+(e.stylusStack?e.stylusStack+"\n":""),e.fromStylus&&(e.stack="Error: "+e.message),e},exports.assertType=function(e,r,n){if(exports.assertPresent(e,n),e.nodeName!=r){var t=e.nodeName,o="expected "+(n?'"'+n+'" to be a ':"")+r+", but got "+t+":"+e;throw new Error("TypeError: "+o)}},exports.assertString=function(e,r){switch(exports.assertPresent(e,r),e.nodeName){case"string":case"ident":case"literal":return;default:var n=e.nodeName,t="expected string, ident or literal, but got "+n+":"+e;throw new Error("TypeError: "+t)}},exports.assertColor=function(e,r){switch(exports.assertPresent(e,r),e.nodeName){case"rgba":case"hsla":return;default:var n=e.nodeName,t="expected rgba or hsla, but got "+n+":"+e;throw new Error("TypeError: "+t)}},exports.assertPresent=function(e,r){if(!e){if(r)throw new Error('"'+r+'" argument required');throw new Error("argument missing")}},exports.unwrap=function(e){return e.preserve?e:"arguments"!=e.nodeName&&"expression"!=e.nodeName?e:1!=e.nodes.length?e:"arguments"!=e.nodes[0].nodeName&&"expression"!=e.nodes[0].nodeName?e:exports.unwrap(e.nodes[0])},exports.coerce=function(e,r){switch(typeof e){case"function":return e;case"string":return new nodes.String(e);case"boolean":return new nodes.Boolean(e);case"number":return new nodes.Unit(e);default:return null==e?nodes.null:Array.isArray(e)?exports.coerceArray(e,r):e.nodeName?e:exports.coerceObject(e,r)}},exports.coerceArray=function(e,r){var n=new nodes.Expression;return e.forEach(function(e){n.push(exports.coerce(e,r))}),n},exports.coerceObject=function(e,r){var n,t=r?new nodes.Object:new nodes.Expression;for(var o in e)n=exports.coerce(e[o],r),o=new nodes.Ident(o),r?t.set(o,n):t.push(exports.coerceArray([o,n]));return t},exports.params=function(e){return e.toString().match(/\(([^)]*)\)/)[1].split(/ *, */)},exports.merge=function(e,r,n){for(var t in r)if(n&&e[t]){var o=exports.unwrap(e[t]).first,s=exports.unwrap(r[t]).first;"object"==o.nodeName&&"object"==s.nodeName?e[t].first.vals=exports.merge(o.vals,s.vals,n):e[t]=r[t]}else e[t]=r[t];return e},exports.uniq=function(e){for(var r={},n=[],t=0,o=e.length;t<o;++t)e[t]in r||(r[e[t]]=!0,n.push(e[t]));return n},exports.compileSelectors=function(e,r){function n(e,r){var n=[e.val],t=new s(n[0],o,n).parse().val,o=[];if(r.length)for(var a=0,i=r.length;a<i;++a){n.push(r[a]),o.push(t);var u=new s(r[a],o,n).parse();u.nested?t+=" "+u.val:t=u.val}return t.trim()}function t(e,s){s?e[s].forEach(function(u){!r&&u.isPlaceholder||(u.inherits?(i.unshift(u.val),t(e,s-1),i.shift()):o.push(a+n(u,i)))}):e[0].forEach(function(e){if(r||!e.isPlaceholder){var t=n(e,i);t&&o.push(a+t)}})}var o=[],s=require("./selector-parser"),a=this.indent||"",i=[];return t(e,e.length-1),exports.uniq(o)},exports.parseString=function(e){var r,n,t=require("./parser");try{r=new t(e),r.state.push("expression"),n=new nodes.Expression,n.nodes=r.parse().nodes}catch(r){n=new nodes.Literal(e)}return n};
