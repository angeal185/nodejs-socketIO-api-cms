function Lexer(t,e){function n(t,e,n,s){var i=s.lastIndexOf("/*",n)>s.lastIndexOf("*/",n),r=s.lastIndexOf("//",n),a=s.lastIndexOf("\n",n),o=0,h=0;if(~r&&r>a)for(;a!=n;){if("'"==s[a]&&(h?h--:h++),'"'==s[a]&&(o?o--:o++),"/"==s[a]&&"/"==s[a+1]){i=!h&&!o;break}++a}return i?t:e+"\r"}e=e||{},this.stash=[],this.indentStack=[],this.indentRe=null,this.lineno=1,this.column=1,"\ufeff"==t.charAt(0)&&(t=t.slice(1)),this.str=t.replace(/\s+$/,"\n").replace(/\r\n?/g,"\n").replace(/\\ *\n/g,"\r").replace(/([,(:](?!\/\/[^ ])) *(?:\/\/[^\n]*|\/\*.*?\*\/)?\n\s*/g,n).replace(/\s*\n[ \t]*([,)])/g,n)}var Token=require("./token"),nodes=require("./nodes"),errors=require("./errors");exports=module.exports=Lexer;var alias={and:"&&",or:"||",is:"==",isnt:"!=","is not":"!=",":=":"?="};Lexer.prototype={inspect:function(){for(var t,e=this.str,n=[];"eos"!=(t=this.next()).type;)n.push(t.inspect());return this.str=e,n.concat(t.inspect()).join("\n")},lookahead:function(t){for(var e=t-this.stash.length;e-- >0;)this.stash.push(this.advance());return this.stash[--t]},skip:function(t){var e=t[0];t=e?e.length:t,this.str=this.str.substr(t),e?this.move(e):this.column+=t},move:function(t){var e=t.match(/\n/g),n=t.lastIndexOf("\n");e&&(this.lineno+=e.length),this.column=~n?t.length-n:this.column+t.length},next:function(){var t=this.stashed()||this.advance();return this.prev=t,t},isPartOfSelector:function(){var t=this.stash[this.stash.length-1]||this.prev;switch(t&&t.type){case"color":return 2==t.val.raw.length;case".":case"[":return!0}return!1},advance:function(){var t=this.column,e=this.lineno,n=this.eos()||this.null()||this.sep()||this.keyword()||this.urlchars()||this.comment()||this.newline()||this.escaped()||this.important()||this.literal()||this.anonFunc()||this.atrule()||this.function()||this.brace()||this.paren()||this.color()||this.string()||this.unit()||this.namedop()||this.boolean()||this.unicode()||this.ident()||this.op()||this.eol()||this.space()||this.selector();return n.lineno=e,n.column=t,n},peek:function(){return this.lookahead(1)},stashed:function(){return this.stash.shift()},eos:function(){if(!this.str.length)return this.indentStack.length?(this.indentStack.shift(),new Token("outdent")):new Token("eos")},urlchars:function(){var t;if(this.isURL)return(t=/^[\/:@.;?&=*!,<>#%0-9]+/.exec(this.str))?(this.skip(t),new Token("literal",new nodes.Literal(t[0]))):void 0},sep:function(){var t;if(t=/^;[ \t]*/.exec(this.str))return this.skip(t),new Token(";")},eol:function(){if("\r"==this.str[0])return++this.lineno,this.skip(1),this.advance()},space:function(){var t;if(t=/^([ \t]+)/.exec(this.str))return this.skip(t),new Token("space")},escaped:function(){var t;if(t=/^\\(.)[ \t]*/.exec(this.str)){var e=t[1];return this.skip(t),new Token("ident",new nodes.Literal(e))}},literal:function(){var t;if(t=/^@css[ \t]*\{/.exec(this.str)){this.skip(t);for(var e,n,s=1,i="";e=this.str[0];){switch(this.str=this.str.substr(1),e){case"{":++s;break;case"}":--s;break;case"\n":case"\r":++this.lineno}if(i+=e,!s)break}return i=i.replace(/\s*}$/,""),n=new nodes.Literal(i),n.css=!0,new Token("literal",n)}},important:function(){var t;if(t=/^!important[ \t]*/.exec(this.str))return this.skip(t),new Token("ident",new nodes.Literal("!important"))},brace:function(){var t;if(t=/^([{}])/.exec(this.str)){this.skip(1);var e=t[1];return new Token(e,e)}},paren:function(){var t;if(t=/^([()])([ \t]*)/.exec(this.str)){var e=t[1];this.skip(t),")"==e&&(this.isURL=!1);var n=new Token(e,e);return n.space=t[2],n}},null:function(){var t;if(t=/^(null)\b[ \t]*/.exec(this.str))return this.skip(t),this.isPartOfSelector()?new Token("ident",new nodes.Ident(t[0])):new Token("null",nodes.null)},keyword:function(){var t;if(t=/^(return|if|else|unless|for|in)\b[ \t]*/.exec(this.str)){var e=t[1];return this.skip(t),this.isPartOfSelector()?new Token("ident",new nodes.Ident(t[0])):new Token(e,e)}},namedop:function(){var t,e;if(t=/^(not|and|or|is a|is defined|isnt|is not|is)(?!-)\b([ \t]*)/.exec(this.str)){var n=t[1];return this.skip(t),this.isPartOfSelector()?e=new Token("ident",new nodes.Ident(t[0])):(n=alias[n]||n,e=new Token(n,n)),e.space=t[2],e}},op:function(){var t;if(t=/^([.]{1,3}|&&|\|\||[!<>=?:]=|\*\*|[-+*\/%]=?|[,=?:!~<>&\[\]])([ \t]*)/.exec(this.str)){var e=t[1];this.skip(t),e=alias[e]||e;var n=new Token(e,e);return n.space=t[2],this.isURL=!1,n}},anonFunc:function(){var t;if("@"==this.str[0]&&"("==this.str[1])return this.skip(2),t=new Token("function",new nodes.Ident("anonymous")),t.anonymous=!0,t},atrule:function(){var t;if(t=/^@(?:-(\w+)-)?([a-zA-Z0-9-_]+)[ \t]*/.exec(this.str)){this.skip(t);var e=t[1],n=t[2];switch(n){case"require":case"import":case"charset":case"namespace":case"media":case"scope":case"supports":return new Token(n);case"document":return new Token("-moz-document");case"block":return new Token("atblock");case"extend":case"extends":return new Token("extend");case"keyframes":return new Token(n,e);default:return new Token("atrule",e?"-"+e+"-"+n:n)}}},comment:function(){if("/"==this.str[0]&&"/"==this.str[1]){var t=this.str.indexOf("\n");return-1==t&&(t=this.str.length),this.skip(t),this.advance()}if("/"==this.str[0]&&"*"==this.str[1]){var t=this.str.indexOf("*/");-1==t&&(t=this.str.length);var e=this.str.substr(0,t+2),n=e.split(/\n|\r/).length-1,s=!0,i=!1;return this.lineno+=n,this.skip(t+2),"!"==e[2]&&(e=e.replace("*!","*"),s=!1),this.prev&&";"==this.prev.type&&(i=!0),new Token("comment",new nodes.Comment(e,s,i))}},boolean:function(){var t;if(t=/^(true|false)\b([ \t]*)/.exec(this.str)){var e=nodes.Boolean("true"==t[1]);this.skip(t);var n=new Token("boolean",e);return n.space=t[2],n}},unicode:function(){var t;if(t=/^u\+[0-9a-f?]{1,6}(?:-[0-9a-f]{1,6})?/i.exec(this.str))return this.skip(t),new Token("literal",new nodes.Literal(t[0]))},function:function(){var t;if(t=/^(-*[_a-zA-Z$][-\w\d$]*)\(([ \t]*)/.exec(this.str)){var e=t[1];this.skip(t),this.isURL="url"==e;var n=new Token("function",new nodes.Ident(e));return n.space=t[2],n}},ident:function(){var t;if(t=/^-*[_a-zA-Z$][-\w\d$]*/.exec(this.str))return this.skip(t),new Token("ident",new nodes.Ident(t[0]))},newline:function(){var t,e;if(this.indentRe?t=this.indentRe.exec(this.str):(e=/^\n([\t]*)[ \t]*/,t=e.exec(this.str),t&&!t[1].length&&(e=/^\n([ \t]*)/,t=e.exec(this.str)),t&&t[1].length&&(this.indentRe=e)),t){var n,s=t[1].length;if(this.skip(t)," "===this.str[0]||"\t"===this.str[0])throw new errors.SyntaxError("Invalid indentation. You can use tabs or spaces to indent, but not both.");if("\n"==this.str[0])return this.advance();if(this.indentStack.length&&s<this.indentStack[0]){for(;this.indentStack.length&&this.indentStack[0]>s;)this.stash.push(new Token("outdent")),this.indentStack.shift();n=this.stash.pop()}else s&&s!=this.indentStack[0]?(this.indentStack.unshift(s),n=new Token("indent")):n=new Token("newline");return n}},unit:function(){var t;if(t=/^(-)?(\d+\.\d+|\d+|\.\d+)(%|[a-zA-Z]+)?[ \t]*/.exec(this.str)){this.skip(t);var e=parseFloat(t[2]);"-"==t[1]&&(e=-e);var n=new nodes.Unit(e,t[3]);return n.raw=t[0],new Token("unit",n)}},string:function(){var t;if(t=/^("[^"]*"|'[^']*')[ \t]*/.exec(this.str)){var e=t[1],n=t[0][0];return this.skip(t),e=e.slice(1,-1).replace(/\\n/g,"\n"),new Token("string",new nodes.String(e,n))}},color:function(){return this.rrggbbaa()||this.rrggbb()||this.rgba()||this.rgb()||this.nn()||this.n()},n:function(){var t;if(t=/^#([a-fA-F0-9]{1})[ \t]*/.exec(this.str)){this.skip(t);var e=parseInt(t[1]+t[1],16),n=new nodes.RGBA(e,e,e,1);return n.raw=t[0],new Token("color",n)}},nn:function(){var t;if(t=/^#([a-fA-F0-9]{2})[ \t]*/.exec(this.str)){this.skip(t);var e=parseInt(t[1],16),n=new nodes.RGBA(e,e,e,1);return n.raw=t[0],new Token("color",n)}},rgb:function(){var t;if(t=/^#([a-fA-F0-9]{3})[ \t]*/.exec(this.str)){this.skip(t);var e=t[1],n=parseInt(e[0]+e[0],16),s=parseInt(e[1]+e[1],16),i=parseInt(e[2]+e[2],16),r=new nodes.RGBA(n,s,i,1);return r.raw=t[0],new Token("color",r)}},rgba:function(){var t;if(t=/^#([a-fA-F0-9]{4})[ \t]*/.exec(this.str)){this.skip(t);var e=t[1],n=parseInt(e[0]+e[0],16),s=parseInt(e[1]+e[1],16),i=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16),a=new nodes.RGBA(n,s,i,r/255);return a.raw=t[0],new Token("color",a)}},rrggbb:function(){var t;if(t=/^#([a-fA-F0-9]{6})[ \t]*/.exec(this.str)){this.skip(t);var e=t[1],n=parseInt(e.substr(0,2),16),s=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16),r=new nodes.RGBA(n,s,i,1);return r.raw=t[0],new Token("color",r)}},rrggbbaa:function(){var t;if(t=/^#([a-fA-F0-9]{8})[ \t]*/.exec(this.str)){this.skip(t);var e=t[1],n=parseInt(e.substr(0,2),16),s=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16),r=parseInt(e.substr(6,2),16),a=new nodes.RGBA(n,s,i,r/255);return a.raw=t[0],new Token("color",a)}},selector:function(){var t;if(t=/^\^|.*?(?=\/\/(?![^\[]*\])|[,\n{])/.exec(this.str)){var e=t[0];return this.skip(t),new Token("selector",e)}}};
