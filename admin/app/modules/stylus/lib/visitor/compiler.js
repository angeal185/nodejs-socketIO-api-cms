var Visitor=require("./"),utils=require("../utils"),fs=require("fs"),Compiler=module.exports=function(t,i){i=i||{},this.compress=i.compress,this.firebug=i.firebug,this.linenos=i.linenos,this.spaces=i["indent spaces"]||2,this.indents=1,Visitor.call(this,t),this.stack=[]};Compiler.prototype.__proto__=Visitor.prototype,Compiler.prototype.compile=function(){return this.visit(this.root)},Compiler.prototype.out=function(t,i){return t},Compiler.prototype.__defineGetter__("indent",function(){return this.compress?"":new Array(this.indents).join(Array(this.spaces+1).join(" "))}),Compiler.prototype.needBrackets=function(t){return 1==this.indents||"atrule"!=t.nodeName||t.hasOnlyProperties},Compiler.prototype.visitRoot=function(t){this.buf="";for(var i=0,s=t.nodes.length;i<s;++i){var e=t.nodes[i];(this.linenos||this.firebug)&&this.debugInfo(e);var o=this.visit(e);o&&(this.buf+=this.out(o+"\n",e))}return this.buf},Compiler.prototype.visitBlock=function(t){var i,s,e=this.compress?"":"\n";if(t.hasProperties&&!t.lacksRenderedSelectors){s=this.needBrackets(t.node),s&&(this.buf+=this.out(this.compress?"{":" {\n"),++this.indents);for(var o=0,r=t.nodes.length;o<r;++o)switch(this.last=r-1==o,i=t.nodes[o],i.nodeName){case"null":case"expression":case"function":case"group":case"block":case"unit":case"media":case"keyframes":case"atrule":case"supports":continue;case!this.compress&&i.inline&&"comment":this.buf=this.buf.slice(0,-1),this.buf+=this.out(" "+this.visit(i)+"\n",i);break;case"property":var n=this.visit(i)+e;this.buf+=this.compress?n:this.out(n,i);break;default:this.buf+=this.out(this.visit(i)+e,i)}s&&(--this.indents,this.buf+=this.out(this.indent+"}"+e))}for(var o=0,r=t.nodes.length;o<r;++o)switch(i=t.nodes[o],i.nodeName){case"group":case"block":case"keyframes":(this.linenos||this.firebug)&&this.debugInfo(i),this.visit(i);break;case"media":case"import":case"atrule":case"supports":this.visit(i);break;case"comment":i.suppress||(this.buf+=this.out(this.indent+this.visit(i)+"\n",i));break;case"charset":case"literal":case"namespace":this.buf+=this.out(this.visit(i)+"\n",i)}},Compiler.prototype.visitKeyframes=function(t){if(t.frames){var i="official"==t.prefix?"":"-"+t.prefix+"-";this.buf+=this.out("@"+i+"keyframes "+this.visit(t.val)+(this.compress?"{":" {\n"),t),this.keyframe=!0,++this.indents,this.visit(t.block),--this.indents,this.keyframe=!1,this.buf+=this.out("}"+(this.compress?"":"\n"))}},Compiler.prototype.visitMedia=function(t){var i=t.val;t.hasOutput&&i.nodes.length&&(this.buf+=this.out("@media ",t),this.visit(i),this.buf+=this.out(this.compress?"{":" {\n"),++this.indents,this.visit(t.block),--this.indents,this.buf+=this.out("}"+(this.compress?"":"\n")))},Compiler.prototype.visitQueryList=function(t){for(var i=0,s=t.nodes.length;i<s;++i)this.visit(t.nodes[i]),s-1!=i&&(this.buf+=this.out(","+(this.compress?"":" ")))},Compiler.prototype.visitQuery=function(t){var i=t.nodes.length;t.predicate&&(this.buf+=this.out(t.predicate+" ")),t.type&&(this.buf+=this.out(t.type+(i?" and ":"")));for(var s=0;s<i;++s)this.buf+=this.out(this.visit(t.nodes[s])),i-1!=s&&(this.buf+=this.out(" and "))},Compiler.prototype.visitFeature=function(t){return t.expr?t.expr.isEmpty?"("+t.name+")":"("+t.name+":"+(this.compress?"":" ")+this.visit(t.expr)+")":t.name},Compiler.prototype.visitImport=function(t){this.buf+=this.out("@import "+this.visit(t.path)+";\n",t)},Compiler.prototype.visitAtrule=function(t){var i=this.compress?"":"\n";this.buf+=this.out(this.indent+"@"+t.type,t),t.val&&(this.buf+=this.out(" "+t.val.trim())),t.block?t.hasOnlyProperties?this.visit(t.block):(this.buf+=this.out(this.compress?"{":" {\n"),++this.indents,this.visit(t.block),--this.indents,this.buf+=this.out(this.indent+"}"+i)):this.buf+=this.out(";"+i)},Compiler.prototype.visitSupports=function(t){t.hasOutput&&(this.buf+=this.out(this.indent+"@supports ",t),this.isCondition=!0,this.buf+=this.out(this.visit(t.condition)),this.isCondition=!1,this.buf+=this.out(this.compress?"{":" {\n"),++this.indents,this.visit(t.block),--this.indents,this.buf+=this.out(this.indent+"}"+(this.compress?"":"\n")))},Compiler.prototype.visitComment=function(t){return this.compress&&t.suppress?"":t.str},Compiler.prototype.visitFunction=function(t){return t.name},Compiler.prototype.visitCharset=function(t){return"@charset "+this.visit(t.val)+";"},Compiler.prototype.visitNamespace=function(t){return"@namespace "+(t.prefix?this.visit(t.prefix)+" ":"")+this.visit(t.val)+";"},Compiler.prototype.visitLiteral=function(t){var i=t.val;return t.css&&(i=i.replace(/^  /gm,"")),i},Compiler.prototype.visitBoolean=function(t){return t.toString()},Compiler.prototype.visitRGBA=function(t){return t.toString()},Compiler.prototype.visitHSLA=function(t){return t.rgba.toString()},Compiler.prototype.visitUnit=function(t){var i=t.type||"",s=t.val,e=s!=(0|s);if(this.compress){if("%"!=i&&"s"!=i&&"ms"!=i&&0==s)return"0";if(e&&s<1&&s>-1)return s.toString().replace("0.",".")+i}return(e?parseFloat(s.toFixed(15)):s).toString()+i},Compiler.prototype.visitGroup=function(t){var i=this.keyframe?[]:this.stack,s=this.compress?",":",\n";if(i.push(t.nodes),t.block.hasProperties){var e=utils.compileSelectors.call(this,i),o=e.length;if(o){this.keyframe&&(s=this.compress?",":", ");for(var r=0;r<o;++r){var n=e[r],p=r==o-1;this.keyframe&&(n=r?n.trim():n),this.buf+=this.out(n+(p?"":s),t.nodes[r])}}else t.block.lacksRenderedSelectors=!0}this.visit(t.block),i.pop()},Compiler.prototype.visitIdent=function(t){return t.name},Compiler.prototype.visitString=function(t){return this.isURL?t.val:t.toString()},Compiler.prototype.visitNull=function(t){return""},Compiler.prototype.visitCall=function(t){this.isURL="url"==t.name;var i=t.args.nodes.map(function(t){return this.visit(t)},this).join(this.compress?",":", ");return this.isURL&&(i='"'+i+'"'),this.isURL=!1,t.name+"("+i+")"},Compiler.prototype.visitExpression=function(t){var i=[],s=this,e=t.nodes.length,o=t.nodes.map(function(t){return s.visit(t)});return o.forEach(function(r,n){var p=n==e-1;if(i.push(r),"/"!=o[n+1]&&"/"!=r&&!p){var h=s.isURL||s.isCondition&&(")"==o[n+1]||"("==r)?"":" ";i.push(t.isList?s.compress?",":", ":h)}}),i.join("")},Compiler.prototype.visitArguments=Compiler.prototype.visitExpression,Compiler.prototype.visitProperty=function(t){var i=this.visit(t.expr).trim(),s=t.name||t.segments.join(""),e=[];return e.push(this.out(this.indent),this.out(s+(this.compress?":":": "),t),this.out(i,t.expr),this.out(this.compress&&this.last?"":";")),e.join("")},Compiler.prototype.debugInfo=function(t){var i="stdin"==t.filename?"stdin":fs.realpathSync(t.filename),s=(t.nodes&&t.nodes.length?t.nodes[0].lineno:t.lineno)||1;this.linenos&&(this.buf+="\n/* line "+s+" : "+i+" */\n"),this.firebug&&(i="file\\:\\/\\/"+i.replace(/([.:\/\\])/g,function(t){return"\\"+("\\"===t?"/":t)}),s="\\00003"+s,this.buf+="\n@media -stylus-debug-info{filename{font-family:"+i+"}line{font-family:"+s+"}}\n")};
