function importFile(t,e,i){var r,n=this.importStack,o=require("../parser");if(t.once){if(this.requireHistory[e])return nodes.null;if(this.requireHistory[e]=!0,i&&!this.includeCSS)return t}if(~n.indexOf(e))throw new Error("import loop has been found");var s=fs.readFileSync(e,"utf8");if(!s.trim())return nodes.null;if(t.path=e,t.dirname=dirname(e),r=fs.statSync(e),t.mtime=r.mtime,this.paths.push(t.dirname),this.options._imports&&this.options._imports.push(t.clone()),n.push(e),nodes.filename=e,i&&(i=new nodes.Literal(s.replace(/\r\n?/g,"\n")),i.lineno=i.column=1,!this.resolveURL))return i;var a=new nodes.Block,l=new o(s,utils.merge({root:a},this.options));try{a=l.parse()}catch(t){var u=l.lexer.lineno,c=l.lexer.column;if(i&&this.includeCSS&&this.resolveURL)return this.warn("ParseError: "+e+":"+u+":"+c+". This file included as-is"),i;throw t.filename=e,t.lineno=u,t.column=c,t.input=s,t}a=a.clone(this.currentBlock),a.parent=this.currentBlock,a.scope=!1;var p=this.visit(a);return n.pop(),this.resolveURL&&!this.resolveURL.nocheck||this.paths.pop(),p}var Visitor=require("./"),units=require("../units"),nodes=require("../nodes"),Stack=require("../stack"),Frame=require("../stack/frame"),utils=require("../utils"),bifs=require("../functions"),dirname=require("path").dirname,colors=require("../colors"),debug=require("debug")("stylus:evaluator"),fs=require("fs"),Evaluator=module.exports=function(t,e){e=e||{},Visitor.call(this,t);var i=this.functions=e.functions||{};this.stack=new Stack,this.imports=e.imports||[],this.globals=e.globals||{},this.paths=e.paths||[],this.prefix=e.prefix||"",this.filename=e.filename,this.includeCSS=e["include css"],this.resolveURL=i.url&&"resolver"==i.url.name&&i.url.options,this.paths.push(dirname(e.filename||".")),this.stack.push(this.global=new Frame(t)),this.warnings=e.warn,this.options=e,this.calling=[],this.importStack=[],this.requireHistory={},this.return=0};Evaluator.prototype.__proto__=Visitor.prototype;var visit=Visitor.prototype.visit;Evaluator.prototype.visit=function(t){try{return visit.call(this,t)}catch(e){if(e.filename)throw e;e.lineno=t.lineno,e.column=t.column,e.filename=t.filename,e.stylusStack=this.stack.toString();try{e.input=fs.readFileSync(e.filename,"utf8")}catch(t){}throw e}},Evaluator.prototype.setup=function(){var t=this.root,e=[];this.populateGlobalScope(),this.imports.forEach(function(t){var i=new nodes.Expression;i.push(new nodes.String(t)),e.push(new nodes.Import(i))},this),t.nodes=e.concat(t.nodes)},Evaluator.prototype.populateGlobalScope=function(){var t=this.global.scope;Object.keys(colors).forEach(function(e){var i=colors[e],r=new nodes.RGBA(i[0],i[1],i[2],i[3]),n=new nodes.Ident(e,r);r.name=e,t.add(n)}),t.add(new nodes.Ident("embedurl",new nodes.Function("embedurl",require("../functions/url")({limit:!1}))));var e=this.globals;Object.keys(e).forEach(function(i){var r=e[i];r.nodeName||(r=new nodes.Literal(r)),t.add(new nodes.Ident(i,r))})},Evaluator.prototype.evaluate=function(){return debug("eval %s",this.filename),this.setup(),this.visit(this.root)},Evaluator.prototype.visitGroup=function(t){return t.nodes=t.nodes.map(function(t){return t.val=this.interpolate(t),debug("ruleset %s",t.val),t},this),t.block=this.visit(t.block),t},Evaluator.prototype.visitReturn=function(t){throw t.expr=this.visit(t.expr),t},Evaluator.prototype.visitMedia=function(t){return t.block=this.visit(t.block),t.val=this.visit(t.val),t},Evaluator.prototype.visitQueryList=function(t){var e,i;if(t.nodes.forEach(this.visit,this),1==t.nodes.length&&(i=t.nodes[0],e=this.lookup(i.type))){if(!(e=e.first.string))return t;var r=require("../parser"),n=new r(e,this.options);t=this.visit(n.queries())}return t},Evaluator.prototype.visitQuery=function(t){return t.predicate=this.visit(t.predicate),t.type=this.visit(t.type),t.nodes.forEach(this.visit,this),t},Evaluator.prototype.visitFeature=function(t){return t.name=this.interpolate(t),t.expr&&(this.return++,t.expr=this.visit(t.expr),this.return--),t},Evaluator.prototype.visitObject=function(t){for(var e in t.vals)t.vals[e]=this.visit(t.vals[e]);return t},Evaluator.prototype.visitMember=function(t){var e=t.left,i=t.right,r=this.visit(e).first;if("object"!=r.nodeName)throw new Error(e.toString()+" has no property ."+i);return t.val&&(this.return++,r.set(i.name,this.visit(t.val)),this.return--),r.get(i.name)},Evaluator.prototype.visitKeyframes=function(t){var e;return t.fabricated?t:(t.val=this.interpolate(t).trim(),(e=this.lookup(t.val))&&(t.val=e.first.string||e.first.name),t.block=this.visit(t.block),"official"!=t.prefix?t:(this.vendors.forEach(function(e){if("ms"!=e){var i=t.clone();i.val=t.val,i.prefix=e,i.block=t.block,i.fabricated=!0,this.currentBlock.push(i)}},this),nodes.null))},Evaluator.prototype.visitFunction=function(t){var e=this.stack.currentFrame.scope.lookup(t.name);return e&&this.warn("local "+e.nodeName+' "'+t.name+'" previously defined in this scope'),this.functions[t.name]&&this.warn('user-defined function "'+t.name+'" is already defined'),bifs[t.name]&&this.warn('built-in function "'+t.name+'" is already defined'),t},Evaluator.prototype.visitEach=function(t){function e(e,r){l.add(r),l.add(e),i=p.visit(t.block.clone()),c=c.concat(i.nodes)}this.return++;var i,r,n=utils.unwrap(this.visit(t.expr)),o=n.nodes.length,s=new nodes.Ident(t.val),a=new nodes.Ident(t.key||"__index__"),l=this.currentScope,u=this.currentBlock,c=[],p=this;if(this.return--,t.block.scope=!1,1==o&&"object"==n.nodes[0].nodeName){r=n.nodes[0];for(var h in r.vals)s.val=new nodes.String(h),a.val=r.get(h),e(a,s)}else for(var d=0;d<o;++d)s.val=n.nodes[d],a.val=new nodes.Unit(d),e(a,s);return this.mixin(c,u),c[c.length-1]||nodes.null},Evaluator.prototype.visitCall=function(t){debug("call %s",t);var e,i,r=this.lookup(t.name);if(this.ignoreColors="url"==t.name,r&&"expression"==r.nodeName&&(r=r.nodes[0]),r&&"function"!=r.nodeName&&(r=this.lookupFunction(t.name)),!r||"function"!=r.nodeName)return debug("%s is undefined",t),"calc"==this.unvendorize(t.name)?(e=t.args.nodes&&t.args.nodes[0])&&(i=new nodes.Literal(t.name+e)):i=this.literalCall(t),this.ignoreColors=!1,i;if(this.calling.push(t.name),this.calling.length>200)throw new RangeError("Maximum stylus call stack size exceeded");"expression"==r.nodeName&&(r=r.first),this.return++;var n=this.visit(t.args);for(var o in n.map)n.map[o]=this.visit(n.map[o].clone());return this.return--,r.fn?(debug("%s is built-in",t),i=this.invokeBuiltin(r.fn,n)):"function"==r.nodeName&&(debug("%s is user-defined",t),t.block&&(t.block=this.visit(t.block)),i=this.invokeFunction(r,n,t.block)),this.calling.pop(),this.ignoreColors=!1,i},Evaluator.prototype.visitIdent=function(t){var e;if(t.property)return(e=this.lookupProperty(t.name))?this.visit(e.expr.clone()):nodes.null;if(t.val.isNull){var i=this.lookup(t.name);return i&&t.mixin&&this.mixinNode(i),i?this.visit(i):t}return this.return++,t.val=this.visit(t.val),this.return--,this.currentScope.add(t),t.val},Evaluator.prototype.visitBinOp=function(t){if("is defined"==t.op)return this.isDefined(t.left);this.return++;var e=t.op,i=this.visit(t.left),r="||"==e||"&&"==e?t.right:this.visit(t.right),n=t.val?this.visit(t.val):null;this.return--;try{return this.visit(i.operate(e,r,n))}catch(t){if("CoercionError"==t.name)switch(e){case"==":return nodes.false;case"!=":return nodes.true}throw t}},Evaluator.prototype.visitUnaryOp=function(t){var e=t.op,i=this.visit(t.expr);switch("!"!=e&&(i=i.first.clone(),utils.assertType(i,"unit")),e){case"-":i.val=-i.val;break;case"+":i.val=+i.val;break;case"~":i.val=~i.val;break;case"!":return i.toBoolean().negate()}return i},Evaluator.prototype.visitTernary=function(t){return this.visit(t.cond).toBoolean().isTrue?this.visit(t.trueExpr):this.visit(t.falseExpr)},Evaluator.prototype.visitExpression=function(t){for(var e=0,i=t.nodes.length;e<i;++e)t.nodes[e]=this.visit(t.nodes[e]);return this.castable(t)&&(t=this.cast(t)),t},Evaluator.prototype.visitArguments=Evaluator.prototype.visitExpression,Evaluator.prototype.visitProperty=function(t){var e=this.interpolate(t),i=this.lookup(e),r=i&&"function"==i.first.nodeName,n=~this.calling.indexOf(e),o=this.property;if(!r||n||t.literal)return this.return++,t.name=e,t.literal=!0,this.property=t,t.expr=this.visit(t.expr),this.property=o,this.return--,t;var s=nodes.Arguments.fromExpression(utils.unwrap(t.expr.clone()));t.name=e,this.property=t,this.return++,this.property.expr=this.visit(t.expr),this.return--;var a=this.visit(new nodes.Call(e,s));return this.property=o,a},Evaluator.prototype.visitRoot=function(t){if(t!=this.root)return t.constructor=nodes.Block,this.visit(t);for(var e=0;e<t.nodes.length;++e)t.index=e,t.nodes[e]=this.visit(t.nodes[e]);return t},Evaluator.prototype.visitBlock=function(t){for(this.stack.push(new Frame(t)),t.index=0;t.index<t.nodes.length;++t.index)try{t.nodes[t.index]=this.visit(t.nodes[t.index])}catch(e){if("return"==e.nodeName){if(this.return)throw this.stack.pop(),e;t.nodes[t.index]=e;break}throw e}return this.stack.pop(),t},Evaluator.prototype.visitAtblock=function(t){return t.block=this.visit(t.block),t},Evaluator.prototype.visitAtrule=function(t){return t.val=this.interpolate(t),t.block&&(t.block=this.visit(t.block)),t},Evaluator.prototype.visitSupports=function(t){var e,i=t.condition;return this.return++,t.condition=this.visit(i),this.return--,e=i.first,1==i.nodes.length&&"string"==e.nodeName&&(t.condition=e.string),t.block=this.visit(t.block),t},Evaluator.prototype.visitIf=function(t){var e,i=this.currentBlock,r=t.negate;this.return++;var n=this.visit(t.cond).first.toBoolean();if(this.return--,t.block.scope=t.block.hasMedia,r)n.isFalse&&(e=this.visit(t.block));else if(n.isTrue)e=this.visit(t.block);else if(t.elses.length)for(var o,s=t.elses,a=s.length,l=0;l<a;++l)if(s[l].cond){if(s[l].block.scope=s[l].block.hasMedia,this.return++,o=this.visit(s[l].cond).first.toBoolean(),this.return--,o.isTrue){e=this.visit(s[l].block);break}}else s[l].scope=s[l].hasMedia,e=this.visit(s[l]);return e&&!t.postfix&&i.node&&~["group","atrule","media","supports","keyframes"].indexOf(i.node.nodeName)?(this.mixin(e.nodes,i),nodes.null):e||nodes.null},Evaluator.prototype.visitExtend=function(t){var e=this.currentBlock;return"group"!=e.node.nodeName&&(e=this.closestGroup),t.selectors.forEach(function(t){e.node.extends.push({selector:this.interpolate(t.clone()).trim(),optional:t.optional,lineno:t.lineno,column:t.column})},this),nodes.null},Evaluator.prototype.visitImport=function(t){this.return++;var e,i,r=this.visit(t.path).first,n=t.once?"require":"import";if(this.return--,debug("import %s",r),"url"==r.name){if(t.once)throw new Error("You cannot @require a url");return t}if(!r.string)throw new Error("@"+n+" string expected");var o=r=r.string;if(/(?:url\s*\(\s*)?['"]?(?:#|(?:https?:)?\/\/)/i.test(r)){if(t.once)throw new Error("You cannot @require a url");return t}if(/\.css(?:"|$)/.test(r)&&(i=!0,!t.once&&!this.includeCSS))return t;if(i||/\.styl$/i.test(r)||(r+=".styl"),e=utils.find(r,this.paths,this.filename),e||(e=utils.lookupIndex(o,this.paths,this.filename)),!e)throw new Error("failed to locate @"+n+" file "+r);for(var s=new nodes.Block,a=0,l=e.length;a<l;++a)s.push(importFile.call(this,t,e[a],i));return s},Evaluator.prototype.invokeFunction=function(t,e,i){var r=new nodes.Block(t.block.parent),n=t.block.clone(r),o=this.stack.currentFrame.block;this.stack.push(new Frame(r));var s=this.currentScope;if("arguments"!=e.nodeName){var a=new nodes.Expression;a.push(e),e=nodes.Arguments.fromExpression(a)}if(s.add(new nodes.Ident("arguments",e)),s.add(new nodes.Ident("mixin",this.return?nodes.false:new nodes.String(o.nodeName))),this.property){var l=this.propertyExpression(this.property,t.name);s.add(new nodes.Ident("current-property",l))}else s.add(new nodes.Ident("current-property",nodes.null));for(var a=new nodes.Expression,u=this.calling.length-1;u--;)a.push(new nodes.Literal(this.calling[u]));s.add(new nodes.Ident("called-from",a));var u=0,c=e.nodes.length;return t.params.nodes.forEach(function(i){if(i.rest){for(i.val=new nodes.Expression;u<c;++u)i.val.push(e.nodes[u]);i.val.preserve=!0,i.val.isList=e.isList}else{var r=e.map[i.name]||e.nodes[u++];if(i=i.clone(),r?r.isEmpty?e.nodes[u-1]=this.visit(i):i.val=r:e.push(i.val),i.val.isNull)throw new Error('argument "'+i+'" required for '+t)}s.add(i)},this),i&&s.add(new nodes.Ident("block",i,!0)),this.invoke(n,!0,t.filename)},Evaluator.prototype.invokeBuiltin=function(t,e){e=t.raw?e.nodes:utils.params(t).reduce(function(t,i){var r=e.map[i]||e.nodes.shift();if(r){r=utils.unwrap(r);var n=r.nodes.length;if(n>1)for(var o=0;o<n;++o)t.push(utils.unwrap(r.nodes[o].first));else t.push(r.first)}return t},[]);var i=utils.coerce(t.apply(this,e)),r=new nodes.Expression;return r.push(i),i=r,this.invoke(i)},Evaluator.prototype.invoke=function(t,e,i){var r;return i&&this.paths.push(dirname(i)),this.return?(r=this.eval(t.nodes),e&&this.stack.pop()):(t=this.visit(t),e&&this.stack.pop(),this.mixin(t.nodes,this.currentBlock),r=nodes.null),i&&this.paths.pop(),r},Evaluator.prototype.mixin=function(t,e){if(t.length){var i=e.nodes.length,r=e.nodes.slice(0,e.index),n=e.nodes.slice(e.index+1,i);this._mixin(t,r,e),e.index=0,e.nodes=r.concat(n)}},Evaluator.prototype._mixin=function(t,e,i){for(var r,n=t.length,o=0;o<n;++o)switch((r=t[o]).nodeName){case"return":return;case"block":this._mixin(r.nodes,e,i);break;case"media":var s=r.block.parent.node;s&&"call"!=s.nodeName&&(r.block.parent=i);case"property":var a=r.expr;r.literal&&"block"==a.first.name&&(a=utils.unwrap(a),a.nodes[0]=new nodes.Literal("block"));default:e.push(r)}},Evaluator.prototype.mixinNode=function(t){switch(t=this.visit(t.first),t.nodeName){case"object":return this.mixinObject(t),nodes.null;case"block":case"atblock":return this.mixin(t.nodes,this.currentBlock),nodes.null}},Evaluator.prototype.mixinObject=function(t){var e,i=require("../parser"),r=this.root,n="$block "+t.toBlock(),o=new i(n,utils.merge({root:e},this.options));try{e=o.parse()}catch(t){throw t.filename=this.filename,t.lineno=o.lexer.lineno,t.column=o.lexer.column,t.input=n,t}e.parent=r,e.scope=!1;for(var s=this.visit(e),a=s.first.nodes,l=0,u=a.length;l<u;++l)if(a[l].block){this.mixin(a[l].block.nodes,this.currentBlock);break}},Evaluator.prototype.eval=function(t){if(!t)return nodes.null;var e=t.length,i=nodes.null;try{for(var r=0;r<e;++r)switch(i=t[r],i.nodeName){case"if":if("block"!=i.block.nodeName){i=this.visit(i);break}case"each":case"block":i=this.visit(i),i.nodes&&(i=this.eval(i.nodes));break;default:i=this.visit(i)}}catch(t){if("return"==t.nodeName)return t.expr;throw t}return i},Evaluator.prototype.literalCall=function(t){return t.args=this.visit(t.args),t},Evaluator.prototype.lookupProperty=function(t){for(var e,i,r,n,o=this.stack.length,s=this.currentBlock.index,a=o;o--;)if(i=this.stack[o].block,i.node)switch(i.node.nodeName){case"group":case"function":case"if":case"each":case"atrule":case"media":case"atblock":case"call":if(e=i.nodes,o+1==a){for(;s--;)if(this.property!=e[s]&&(n=this.interpolate(e[s]),t==n))return e[s].clone()}else for(r=e.length;r--;)if("property"==e[r].nodeName&&this.property!=e[r]&&(n=this.interpolate(e[r]),t==n))return e[r].clone()}return e.null},Evaluator.prototype.__defineGetter__("closestBlock",function(){for(var t,e=this.stack.length;e--;)if(t=this.stack[e].block,t.node)switch(t.node.nodeName){case"group":case"keyframes":case"atrule":case"atblock":case"media":case"call":return t}}),Evaluator.prototype.__defineGetter__("closestGroup",function(){for(var t,e=this.stack.length;e--;)if(t=this.stack[e].block,t.node&&"group"==t.node.nodeName)return t}),Evaluator.prototype.__defineGetter__("selectorStack",function(){for(var t,e=[],i=0,r=this.stack.length;i<r;++i)t=this.stack[i].block,t.node&&"group"==t.node.nodeName&&(t.node.nodes.forEach(function(t){t.val||(t.val=this.interpolate(t))},this),e.push(t.node.nodes));return e}),Evaluator.prototype.lookup=function(t){var e;if(!(this.ignoreColors&&t in colors))return(e=this.stack.lookup(t))?utils.unwrap(e):this.lookupFunction(t)},Evaluator.prototype.interpolate=function(t){function e(t){switch(t.nodeName){case"function":case"ident":return t.name;case"literal":case"string":return!i.prefix||t.prefixed||t.val.nodeName||(t.val=t.val.replace(/\./g,"."+i.prefix),t.prefixed=!0),t.val;case"unit":return"%"==t.type?t.val+"%":t.val;case"member":return e(i.visit(t));case"expression":if(i.calling&&~i.calling.indexOf("selector")&&i._selector)return i._selector;i.return++;var n=e(i.visit(t).first);return i.return--,r&&(i._selector=n),n}}var i=this,r="selector"==t.nodeName;return t.segments?t.segments.map(e).join(""):e(t)},Evaluator.prototype.lookupFunction=function(t){var e=this.functions[t]||bifs[t];if(e)return new nodes.Function(t,e)},Evaluator.prototype.isDefined=function(t){if("ident"==t.nodeName)return nodes.Boolean(this.lookup(t.name));throw new Error('invalid "is defined" check on non-variable '+t)},Evaluator.prototype.propertyExpression=function(t,e){function i(t){return"call"==t.nodeName&&e==t.name?new nodes.Literal("__CALL__"):(t.nodes&&(t.nodes=t.nodes.map(i)),t)}var r=new nodes.Expression,n=t.expr.clone();return r.push(new nodes.String(t.name)),i(n),r.push(n),r},Evaluator.prototype.cast=function(t){return new nodes.Unit(t.first.val,t.nodes[1].name)},Evaluator.prototype.castable=function(t){return 2==t.nodes.length&&"unit"==t.first.nodeName&&~units.indexOf(t.nodes[1].name)},Evaluator.prototype.warn=function(t){this.warnings&&console.warn("[33mWarning:[0m "+t)},Evaluator.prototype.__defineGetter__("currentBlock",function(){return this.stack.currentFrame.block}),Evaluator.prototype.__defineGetter__("vendors",function(){return this.lookup("vendors").nodes.map(function(t){return t.string})}),Evaluator.prototype.unvendorize=function(t){for(var e=0,i=this.vendors.length;e<i;e++)if("official"!=this.vendors[e]){var r="-"+this.vendors[e]+"-";if(~t.indexOf(r))return t.replace(r,"")}return t},Evaluator.prototype.__defineGetter__("currentScope",function(){return this.stack.currentFrame.scope}),Evaluator.prototype.__defineGetter__("currentFrame",function(){return this.stack.currentFrame});
