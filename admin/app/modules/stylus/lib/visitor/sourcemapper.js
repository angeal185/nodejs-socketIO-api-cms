var Compiler=require("./compiler"),SourceMapGenerator=require("source-map").SourceMapGenerator,basename=require("path").basename,extname=require("path").extname,dirname=require("path").dirname,join=require("path").join,relative=require("path").relative,sep=require("path").sep,fs=require("fs"),SourceMapper=module.exports=function(e,t){t=t||{},this.column=1,this.lineno=1,this.contents={},this.filename=t.filename,this.dest=t.dest;var i=t.sourcemap;this.basePath=i.basePath||".",this.inline=i.inline,this.comment=i.comment,this.dest&&".css"===extname(this.dest)?(this.basename=basename(this.dest),this.dest=dirname(this.dest)):this.basename=basename(this.filename,extname(this.filename))+".css",this.utf8=!1,this.map=new SourceMapGenerator({file:this.basename,sourceRoot:i.sourceRoot||null}),Compiler.call(this,e,t)};SourceMapper.prototype.__proto__=Compiler.prototype;var compile=Compiler.prototype.compile;SourceMapper.prototype.compile=function(){var e,t=compile.call(this),i=this.basename+".map",n=this.normalizePath(this.dest?join(this.dest,i):join(dirname(this.filename),i));return this.inline&&(e=this.map.toString(),n="data:application/json;"+(this.utf8?"charset=utf-8;":"")+"base64,"+new Buffer(e).toString("base64")),(this.inline||!1!==this.comment)&&(t+="/*# sourceMappingURL="+n+" */"),t},SourceMapper.prototype.out=function(e,t){if(t&&t.lineno){var i=this.normalizePath(t.filename);this.map.addMapping({original:{line:t.lineno,column:t.column-1},generated:{line:this.lineno,column:this.column-1},source:i}),this.inline&&!this.contents[i]&&(this.map.setSourceContent(i,fs.readFileSync(t.filename,"utf-8")),this.contents[i]=!0)}return this.move(e),e},SourceMapper.prototype.move=function(e){var t=e.match(/\n/g),i=e.lastIndexOf("\n");t&&(this.lineno+=t.length),this.column=~i?e.length-i:this.column+e.length},SourceMapper.prototype.normalizePath=function(e){return e=relative(this.dest||this.basePath,e),"\\"==sep&&(e=e.replace(/^[a-z]:\\/i,"/").replace(/\\/g,"/")),e};var literal=Compiler.prototype.visitLiteral;SourceMapper.prototype.visitLiteral=function(e){var t=literal.call(this,e),i=this.normalizePath(e.filename),n=/^\s+/,a=t.split("\n");return a.length>1&&a.forEach(function(t,a){var r=t.match(n),s=r&&r[0]?r[0].length:0;e.css&&(s+=2),this.map.addMapping({original:{line:e.lineno+a,column:s},generated:{line:this.lineno+a,column:0},source:i})},this),t};var charset=Compiler.prototype.visitCharset;SourceMapper.prototype.visitCharset=function(e){return this.utf8="utf-8"==e.val.string.toLowerCase(),charset.call(this,e)};
