var Visitor=require("./"),Parser=require("../parser"),nodes=require("../nodes"),utils=require("../utils"),dirname=require("path").dirname,fs=require("fs"),DepsResolver=module.exports=function(s,t){this.root=s,this.filename=t.filename,this.paths=t.paths||[],this.paths.push(dirname(t.filename||".")),this.options=t,this.functions={},this.deps=[]};DepsResolver.prototype.__proto__=Visitor.prototype;var visit=DepsResolver.prototype.visit;DepsResolver.prototype.visit=function(s){switch(s.nodeName){case"root":case"block":case"expression":this.visitRoot(s);break;case"group":case"media":case"atblock":case"atrule":case"keyframes":case"each":case"supports":this.visit(s.block);break;default:visit.call(this,s)}},DepsResolver.prototype.visitRoot=function(s){for(var t=0,e=s.nodes.length;t<e;++t)this.visit(s.nodes[t])},DepsResolver.prototype.visitIdent=function(s){this.visit(s.val)},DepsResolver.prototype.visitIf=function(s){this.visit(s.block),this.visit(s.cond);for(var t=0,e=s.elses.length;t<e;++t)this.visit(s.elses[t])},DepsResolver.prototype.visitFunction=function(s){this.functions[s.name]=s.block},DepsResolver.prototype.visitCall=function(s){s.name in this.functions&&this.visit(this.functions[s.name]),s.block&&this.visit(s.block)},DepsResolver.prototype.visitImport=function(s){var t,e,i,o=s.path.first.val;if(o&&(t=/\.css(?:"|$)/.test(o),t||/\.styl$/i.test(o)||(i=o,o+=".styl"),e=utils.find(o,this.paths,this.filename),!e&&i&&(e=utils.lookupIndex(i,this.paths,this.filename)),e&&(this.deps=this.deps.concat(e),!t)))for(var r=0,n=e.length;r<n;++r){var p=e[r],a=dirname(p),l=fs.readFileSync(p,"utf-8"),h=new nodes.Block,c=new Parser(l,utils.merge({root:h},this.options));~this.paths.indexOf(a)||this.paths.push(a);try{h=c.parse()}catch(s){throw s.filename=p,s.lineno=c.lexer.lineno,s.column=c.lexer.column,s.input=l,s}this.visit(h)}},DepsResolver.prototype.resolve=function(){return this.visit(this.root),utils.uniq(this.deps)};
