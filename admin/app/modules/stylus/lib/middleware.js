function checkImports(e,r){var t=imports[e];if(!t)return r();if(!t.length)return r();var i=t.length,n=[];t.forEach(function(e){fs.stat(e.path,function(t,s){(t||!e.mtime||s.mtime>e.mtime)&&n.push(e.path),--i||r(n)})})}function compare(e,r){e=e.split(sep),r=r.split("/"),e[e.length-1]||e.pop(),r[0]||r.shift();for(var t=[];e[e.length-1]==r[0];)t.push(e.pop()),r.shift();return t.join("/")}var stylus=require("./stylus"),fs=require("fs"),url=require("url"),dirname=require("path").dirname,mkdirp=require("mkdirp"),join=require("path").join,sep=require("path").sep,debug=require("debug")("stylus:middleware"),imports={};module.exports=function(e){"string"==typeof(e=e||{})&&(e={src:e});var r=e.force,t=e.src;if(!t)throw new Error('stylus.middleware() requires "src" directory');var i=e.dest||t;return e.compile=e.compile||function(r,t){return e.sourcemap&&("boolean"==typeof e.sourcemap&&(e.sourcemap={}),e.sourcemap.inline=!0),stylus(r).set("filename",t).set("compress",e.compress).set("firebug",e.firebug).set("linenos",e.linenos).set("sourcemap",e.sourcemap)},function(n,s,o){function u(e){o("ENOENT"==e.code?null:e)}function f(){debug("read %s",m),fs.readFile(a,"utf8",function(r,t){if(r)return u(r);var i=e.compile(t,a),n=i.options._imports=[];imports[a]=null,i.render(function(e,r){if(e)return o(e);debug("render %s",a),imports[a]=n,mkdirp(dirname(m),parseInt("0700",8),function(e){if(e)return u(e);fs.writeFile(m,r,"utf8",o)})})})}if("GET"!=n.method&&"HEAD"!=n.method)return o();var p=url.parse(n.url).pathname;if(/\.css$/.test(p)){if("string"==typeof i){var c=compare(i,p).length;"/"==p.charAt(0)&&c++,p=p.slice(c)}var m,a;if(m="function"==typeof i?i(p):join(i,p),a="function"==typeof t?t(p):join(t,p.replace(".css",".styl")),r)return f();if(!imports[a])return f();fs.stat(a,function(e,r){if(e)return u(e);fs.stat(m,function(e,t){e?"ENOENT"==e.code?(debug("not found %s",m),f()):o(e):r.mtime>t.mtime?(debug("modified %s",m),f()):checkImports(a,function(e){debug&&e.length&&e.forEach(function(e){debug("modified import %s",e)}),e.length?f():o()})})})}else o()}};
