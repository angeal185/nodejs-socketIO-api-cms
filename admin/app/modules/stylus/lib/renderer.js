function Renderer(e,t){t=t||{},t.globals=t.globals||{},t.functions=t.functions||{},t.use=t.use||[],t.use=Array.isArray(t.use)?t.use:[t.use],t.imports=[join(__dirname,"functions")],t.paths=t.paths||[],t.filename=t.filename||"stylus",t.Evaluator=t.Evaluator||Evaluator,this.options=t,this.str=e,this.events=events}var Parser=require("./parser"),EventEmitter=require("events").EventEmitter,Evaluator=require("./visitor/evaluator"),Normalizer=require("./visitor/normalizer"),events=new EventEmitter,utils=require("./utils"),nodes=require("./nodes"),join=require("path").join;module.exports=Renderer,Renderer.prototype.__proto__=EventEmitter.prototype,module.exports.events=events,Renderer.prototype.render=function(e){for(var t=this.parser=new Parser(this.str,this.options),r=0,i=this.options.use.length;r<i;r++)this.use(this.options.use[r]);try{nodes.filename=this.options.filename;var o=t.parse();this.evaluator=new this.options.Evaluator(o,this.options),this.nodes=nodes,this.evaluator.renderer=this,o=this.evaluator.evaluate();o=new Normalizer(o,this.options).normalize();var n=this.options.sourcemap?new(require("./visitor/sourcemapper"))(o,this.options):new(require("./visitor/compiler"))(o,this.options),s=n.compile();this.options.sourcemap&&(this.sourcemap=n.map.toJSON())}catch(r){var u={};if(u.input=r.input||this.str,u.filename=r.filename||this.options.filename,u.lineno=r.lineno||t.lexer.lineno,u.column=r.column||t.lexer.column,!e)throw utils.formatException(r,u);return e(utils.formatException(r,u))}var a=this.listeners("end");e&&a.push(e);for(var r=0,i=a.length;r<i;r++){var p=a[r](null,s);p&&(s=p)}if(!e)return s},Renderer.prototype.deps=function(e){var t=utils.merge({cache:!1},this.options);e&&(t.filename=e);var r=require("./visitor/deps-resolver"),i=new Parser(this.str,t);try{nodes.filename=t.filename;return new r(i.parse(),t).resolve()}catch(e){var o={};throw o.input=e.input||this.str,o.filename=e.filename||t.filename,o.lineno=e.lineno||i.lexer.lineno,o.column=e.column||i.lexer.column,utils.formatException(e,o)}},Renderer.prototype.set=function(e,t){return this.options[e]=t,this},Renderer.prototype.get=function(e){return this.options[e]},Renderer.prototype.include=function(e){return this.options.paths.push(e),this},Renderer.prototype.use=function(e){return e.call(this,this),this},Renderer.prototype.define=function(e,t,r){return t=utils.coerce(t,r),t.nodeName?(this.options.globals[e]=t,this):(this.options.functions[e]=t,void 0!=r&&(t.raw=r),this)},Renderer.prototype.import=function(e){return this.options.imports.push(e),this};
