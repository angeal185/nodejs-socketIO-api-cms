var COMBINATORS=[">","+","~"],SelectorParser=module.exports=function(t,s,r){this.str=t,this.stack=s||[],this.parts=r||[],this.pos=0,this.level=2,this.nested=!0,this.ignore=!1};SelectorParser.prototype.skip=function(t){this.str=this.str.substr(t),this.pos+=t},SelectorParser.prototype.skipSpaces=function(){for(;" "==this.str[0];)this.skip(1)},SelectorParser.prototype.advance=function(){return this.root()||this.relative()||this.initial()||this.escaped()||this.parent()||this.partial()||this.char()},SelectorParser.prototype.root=function(){this.pos||"/"!=this.str[0]||"deep"==this.str.slice(1,5)||(this.nested=!1,this.skip(1))},SelectorParser.prototype.relative=function(t){if((!this.pos||t)&&"../"==this.str.slice(0,3)){for(this.nested=!1,this.skip(3);this.relative(!0);)this.level++;if(!this.raw){var s=this.stack[this.stack.length-this.level];if(s)return s;this.ignore=!0}}},SelectorParser.prototype.initial=function(){if(!this.pos&&"~"==this.str[0]&&"/"==this.str[1])return this.nested=!1,this.skip(2),this.stack[0]},SelectorParser.prototype.escaped=function(){if("\\"==this.str[0]){var t=this.str[1];if("&"==t||"^"==t)return this.skip(2),t}},SelectorParser.prototype.parent=function(){if("&"==this.str[0]){if(this.nested=!1,!this.pos&&(!this.stack.length||this.raw)){for(var t=0;" "==this.str[++t];);if(~COMBINATORS.indexOf(this.str[t]))return void this.skip(t+1)}if(this.skip(1),!this.raw)return this.stack[this.stack.length-1]}},SelectorParser.prototype.partial=function(){if("^"==this.str[0]&&"["==this.str[1]){this.skip(2),this.skipSpaces();var t=this.range();if(this.skipSpaces(),"]"!=this.str[0])return"^[";if(this.nested=!1,this.skip(1),t)return t;this.ignore=!0}},SelectorParser.prototype.number=function(){var t=0,s="";for("-"==this.str[t]&&(s+=this.str[t++]);this.str.charCodeAt(t)>=48&&this.str.charCodeAt(t)<=57;)s+=this.str[t++];if(s)return this.skip(t),Number(s)},SelectorParser.prototype.range=function(){var t,s=this.number();if(".."==this.str.slice(0,2)){this.skip(2);var r=this.number(),i=this.parts.length;if(s<0&&(s=i+s-1),r<0&&(r=i+r-1),s>r){var e=s;s=r,r=e}r<i-1&&(t=this.parts.slice(s,r+1).map(function(t){var s=new SelectorParser(t,this.stack,this.parts);return s.raw=!0,s.parse()},this).map(function(t){return(t.nested?" ":"")+t.val}).join("").trim())}else t=this.stack[s<0?this.stack.length+s-1:s];if(t)return t;this.ignore=!0},SelectorParser.prototype.char=function(){var t=this.str[0];return this.skip(1),t},SelectorParser.prototype.parse=function(){for(var t="";this.str.length;)if(t+=this.advance()||"",this.ignore){t="";break}return{val:t.trimRight(),nested:this.nested}};
